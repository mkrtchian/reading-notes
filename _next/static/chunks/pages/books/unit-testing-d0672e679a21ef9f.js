(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{5032:function(e,s,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/books/unit-testing",function(){return n(2501)}])},2501:function(e,s,n){"use strict";n.r(s),n.d(s,{__toc:function(){return t}});var l=n(5893),r=n(2673),i=n(2643),o=n(7854);let t=[{depth:2,value:"I - The bigger picture",id:"i---the-bigger-picture"},{depth:3,value:"1 - The goal of unit testing",id:"1---the-goal-of-unit-testing"},{depth:3,value:"2 - What is a unit test?",id:"2---what-is-a-unit-test"},{depth:3,value:"3 - The anatomy of a unit test",id:"3---the-anatomy-of-a-unit-test"},{depth:2,value:"II - Making your tests work for you",id:"ii---making-your-tests-work-for-you"},{depth:3,value:"4 - The four pillars of a good unit test",id:"4---the-four-pillars-of-a-good-unit-test"},{depth:3,value:"5 - Mocks and test fragility",id:"5---mocks-and-test-fragility"},{depth:3,value:"6 - Styles of unit testing",id:"6---styles-of-unit-testing"},{depth:3,value:"7 - Refactoring toward valuable unit tests",id:"7---refactoring-toward-valuable-unit-tests"},{depth:2,value:"III - Integration testing",id:"iii---integration-testing"},{depth:3,value:"8 - Why integration testing?",id:"8---why-integration-testing"},{depth:3,value:"9 - Mocking best practices",id:"9---mocking-best-practices"},{depth:3,value:"10 - Testing the database",id:"10---testing-the-database"},{depth:2,value:"IV - Unit testing anti-patterns",id:"iv---unit-testing-anti-patterns"},{depth:3,value:"11 - Unit testing anti-patterns",id:"11---unit-testing-anti-patterns"}];function a(e){let s=Object.assign({h1:"h1",h2:"h2",h3:"h3",ul:"ul",li:"li",strong:"strong",em:"em",code:"code",pre:"pre",span:"span",p:"p",a:"a"},(0,i.a)(),e.components);return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.h1,{children:"Unit Testing: Principles, Practices, and Patterns"}),"\n",(0,l.jsx)(s.h2,{id:"i---the-bigger-picture",children:"I - The bigger picture"}),"\n",(0,l.jsx)(s.h3,{id:"1---the-goal-of-unit-testing",children:"1 - The goal of unit testing"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["De nos jours, la plupart des entreprises cr\xe9ent des tests pour leurs logiciels.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"En moyenne le ratio code de test / code de prod est entre 1/1 et 3/1 (en faveur du code de test), et parfois plus."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Le but principal des unit tests c'est de ",(0,l.jsx)(s.strong,{children:"permettre une croissance durable du projet"}),". Sans eux, le temps de d\xe9veloppement explose au bout d'un moment.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["On appelle cette explosion la ",(0,l.jsx)(s.em,{children:"software entropy"})," : la d\xe9sorganisation progressive du code."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Le fait qu'un code soit ",(0,l.jsx)(s.strong,{children:"difficilement testable"})," est un signe de mauvaise conception \xe0 cause d'un couplage inappropri\xe9. C'est un ",(0,l.jsx)(s.strong,{children:"bon indicateur n\xe9gatif"}),". Par contre, si le code est testable, \xe7a ne veut pas dire qu'il est bon, on ne peut pas en faire un indicateur positif."]}),"\n",(0,l.jsxs)(s.li,{children:["Les tests sont un code comme un autre, ils ont un ",(0,l.jsx)(s.strong,{children:"co\xfbt de maintenance"}),", et peuvent avoir une valeur nulle ou m\xeame n\xe9gative. Il vaut mieux ne garder que les bons tests."]}),"\n",(0,l.jsxs)(s.li,{children:["Le ",(0,l.jsx)(s.strong,{children:"code coverage"})," est un ",(0,l.jsx)(s.strong,{children:"bon indicateur n\xe9gatif"})," : si le code coverage est faible c'est que le code est peu test\xe9. Par contre, si le coverage est \xe9lev\xe9, on ne peut rien conclure : c'est un mauvais indicateur positif.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Le probl\xe8me du coverage c'est :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Qu'",(0,l.jsx)(s.strong,{children:"on ne peut pas s'assurer qu'on v\xe9rifie tout ce qui est fait"}),". Par exemple, si un code renvoie un r\xe9sultat et assigne ce r\xe9sultat dans une variable globale, et que le test v\xe9rifie seulement l'une de ces choses, on ne pourra pas savoir que l'autre n'est pas test\xe9e malgr\xe9 le coverage de 100%."]}),"\n",(0,l.jsxs)(s.li,{children:["Qu'",(0,l.jsx)(s.strong,{children:"on ne teste pas les chemins permis par nos d\xe9pendances"}),". On d\xe9l\xe8gue souvent des responsabilit\xe9s \xe0 des d\xe9pendances qui permettent beaucoup de flexibilit\xe9, mais sans tester chaque possibilit\xe9 offerte. Et on ne peut pas v\xe9rifier qu'on le fait.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Le simple fait de faire un ",(0,l.jsx)(s.code,{children:"parseInt(variable)"})," fera que ",(0,l.jsx)(s.code,{children:"variable"})," marchera dans des cas pr\xe9cis support\xe9s par la fonction standard ",(0,l.jsx)(s.code,{children:"parseInt()"}),". Pour autant, on ne peut pas s'assurer de tester chacun de ces chemins et leurs cons\xe9quences avec notre code."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Se fixer le coverage comme ",(0,l.jsx)(s.strong,{children:"target"})," cr\xe9e un incentive pervers qui va \xe0 l'encontre de l'objectif du unit testing. Le coverage doit rester un ",(0,l.jsx)(s.strong,{children:"indicateur"})," (n\xe9gatif)."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Le ",(0,l.jsx)(s.strong,{children:"branch coverage"})," est une autre forme de coverage qui compte le nombre d'embranchements (if, switch etc.) test\xe9s sur le nombre total d'embranchements. C'est un peu mieux que le code coverage, mais \xe7a reste pour autant seulement un indicateur n\xe9gatif."]}),"\n",(0,l.jsxs)(s.li,{children:["Un ",(0,l.jsx)(s.strong,{children:"bon test"})," c'est un test qui :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"est int\xe9gr\xe9 au cycle de d\xe9veloppement, ex\xe9cut\xe9 le plus souvent possible."}),"\n",(0,l.jsx)(s.li,{children:"teste les parties les plus importantes de la codebase. En g\xe9n\xe9ral c'est la logique business."}),"\n",(0,l.jsx)(s.li,{children:"offre une grande valeur compar\xe9 aux co\xfbts de sa maintenance."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"2---what-is-a-unit-test",children:"2 - What is a unit test?"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Il existe deux \xe9coles de unit testing : la ",(0,l.jsx)(s.strong,{children:"classical school"})," (qu'on pratiquait \xe0 l'origine), et la ",(0,l.jsx)(s.strong,{children:"London school"}),", qui est n\xe9e \xe0 Londres.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Un livre canonique pour le style classique est ",(0,l.jsx)(o.f,{children:"Test-Driven Development: By Example"})," de Kent Beck, et un livre pour le style London est ",(0,l.jsx)(o.f,{children:"Growing Object -Oriented Software, Guided by Tests"})," de Steve Freeman et Nat Pryce."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Un ",(0,l.jsx)(s.strong,{children:"unit test"})," est un test qui v\xe9rifie une ",(0,l.jsx)(s.strong,{children:"unit\xe9 de code"}),", de mani\xe8re ",(0,l.jsx)(s.strong,{children:"rapide"}),", et ",(0,l.jsx)(s.strong,{children:"isol\xe9e"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["Le code test\xe9 peut avoir des d\xe9pendances.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Les ",(0,l.jsx)(s.strong,{children:"shared dependencies"})," sont celles qui affectent les tests entre eux parce qu'ils sont chang\xe9s par le code et ne sont pas r\xe9initialis\xe9s entre les tests. Par exemple, une base de donn\xe9es est shared. Elle pourrait ne pas l'\xeatre si elle \xe9tait instanci\xe9e \xe0 chaque test."]}),"\n",(0,l.jsxs)(s.li,{children:["Les ",(0,l.jsx)(s.strong,{children:"private dependencies"})," sont celles qui ne sont pas partag\xe9es."]}),"\n",(0,l.jsxs)(s.li,{children:["Les ",(0,l.jsx)(s.strong,{children:"out-of-process dependencies"})," sont celles qui sont ex\xe9cut\xe9es dans un autre processus. Elles impliquent un temps d'ex\xe9cution plus important que de rester dans le m\xeame processus que le code ex\xe9cut\xe9. La base de donn\xe9es est out-of-process, m\xeame si on l'instancie \xe0 chaque fois."]}),"\n",(0,l.jsxs)(s.li,{children:["Les ",(0,l.jsx)(s.strong,{children:"volatile dependencies"})," sont soit non install\xe9es sur un environnement par d\xe9faut (c'est le cas d'une base de donn\xe9es, mais pas d'un filesystem par exemple), soit on un comportement non d\xe9terministe (par exemple ",(0,l.jsx)(s.code,{children:"new Date()"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["A propos de la gestion de d\xe9pendances, l'auteur conseille ",(0,l.jsx)(o.f,{children:"Dependency Injection: Principles, Practices, Patterns"})," de Steven Deursen et Mark Seemann."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["On appellera par la suite","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"collaborators"})," les d\xe9pendances qui sont soit shared, soit mutables (un objet utilis\xe9 par l'objet qu'on teste, la base de donn\xe9es etc.)"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"values"})," les d\xe9pendances qui sont immutables (par exemple un Value Object, le nombre 5 etc.)."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["La controverse entre les deux \xe9coles porte sur ",(0,l.jsx)(s.strong,{children:"l'isolation"})," :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Pour la London school l'isolation porte sur le code test\xe9.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Tout collaborator qui n'est pas directement test\xe9 doit \xeatre remplac\xe9 dans les tests par un ",(0,l.jsx)(s.strong,{children:"test double"})," (c'est le terme g\xe9n\xe9rique, le terme ",(0,l.jsx)(s.em,{children:"mock"})," est une forme particuli\xe8re de test double). On tol\xe8re seulement les d\xe9pendances immutables (les values)."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Le “unit” c'est l'unit\xe9 de code (la classe)"}),", donc on a un fichier de test par classe."]}),"\n",(0,l.jsxs)(s.li,{children:["Avantages :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\xc7a permet de tester du code m\xeame tr\xe8s coupl\xe9, en rempla\xe7ant simplement les d\xe9pendances dans les tests par des doubles."}),"\n",(0,l.jsx)(s.li,{children:"\xc7a permet d'\xeatre s\xfbr que seul un test ne marchera plus si une fonctionnalit\xe9 ne marche plus."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Inconv\xe9nients :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"\xc7a ne force pas \xe0 faire du code d\xe9coupl\xe9."}),"\n",(0,l.jsx)(s.li,{children:"Les tests cassent facilement au moindre refactoring."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pour la classical school l'isolation porte sur les tests entre eux : il faut pouvoir les jouer en parall\xe8le sans qu'ils s'affectent mutuellement.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On n'utilise les doubles que tr\xe8s peu, seulement pour \xe9liminer les shared dependencies."}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Le “unit” c'est le comportement (la fonctionnalit\xe9)"}),", et celle-ci peut contenir plusieurs classes qui seront toutes instanci\xe9es indirectement dans les tests."]}),"\n",(0,l.jsxs)(s.li,{children:["Avantages :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Ca force \xe0 faire du code d\xe9coupl\xe9."}),"\n",(0,l.jsx)(s.li,{children:"Cela permet d'avoir des tests qui collent mieux au cas d'usage business, et qui sont moins fragiles aux refactorings."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Inconv\xe9nients :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Si une fonctionnalit\xe9 ne marche pas, plusieurs tests peuvent casser.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Mais si on rejoue tous les tests \xe0 chaque changement de code, on peut savoir que c'est lui qui vient de faire passer les tests au rouge."}),"\n",(0,l.jsx)(s.li,{children:"Et en plus si un changement casse beaucoup de tests, \xe7a permet de savoir que cette partie du code est tr\xe8s importante."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Les deux \xe9coles ont aussi une diff\xe9rence dans leur rapport au TDD :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["La London school va avoir tendance \xe0 faire du ",(0,l.jsx)(s.strong,{children:"outside-in TDD"}),", en construisant d'abord les classes de plus haut niveau utilisant des collaborators sous forme de test doubles. Puis les impl\xe9menter petit \xe0 petit en allant vers le d\xe9tail."]}),"\n",(0,l.jsxs)(s.li,{children:["La classical school va plut\xf4t mener \xe0 du ",(0,l.jsx)(s.strong,{children:"inside-out TDD"}),", en partant des classes les plus bas niveau dans le mod\xe8le, pour construire par-dessus jusqu'aux couches sup\xe9rieures."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Un ",(0,l.jsx)(s.strong,{children:"test d'int\xe9gration"})," est un test qui ne r\xe9pond pas \xe0 une des 3 caract\xe9ristiques du test unitaire (tester une unit\xe9, de mani\xe8re rapide et isol\xe9e).","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Pour la London school, les caract\xe9ristiques sont :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"V\xe9rifier le comportement d'une seule classe."}),"\n",(0,l.jsx)(s.li,{children:"Le faire vite."}),"\n",(0,l.jsx)(s.li,{children:"Le faire en isolation vis-\xe0-vis des d\xe9pendances de cette classe (gr\xe2ce aux doubles)."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pour la classical school :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"V\xe9rifier le comportement d'une unit\xe9 de comportement."}),"\n",(0,l.jsx)(s.li,{children:"Le faire vite."}),"\n",(0,l.jsx)(s.li,{children:"Le faire avec des tests isol\xe9s les uns par rapport aux autres."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Du coup pour savoir ce qui est test d'int\xe9gration :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"La plupart des tests unitaires selon la classical school sont des tests d'int\xe9gration pour la London school puisqu'ils font intervenir plusieurs classes."}),"\n",(0,l.jsx)(s.li,{children:"Un test qui teste plusieurs unit\xe9s de comportement sera un test d'int\xe9gration pour la classical school."}),"\n",(0,l.jsx)(s.li,{children:"Dans le cas o\xf9 on a une out-of-process dependency (comme une DB) impliqu\xe9e, les tests sont lents donc on sera sur des tests d'int\xe9gration pour les deux \xe9coles."}),"\n",(0,l.jsx)(s.li,{children:"Si on a une shared dependency (comme une DB) impliqu\xe9e, l\xe0 encore on aura un test d'int\xe9gration pour les deux \xe9coles."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Un ",(0,l.jsx)(s.strong,{children:"test end-to-end"})," est un test d'int\xe9gration qui teste toutes les d\xe9pendances out-of-process (ou la plupart d'entre elles), l\xe0 o\xf9 les autres tests d'int\xe9gration n'en testent qu'une ou deux (genre juste la DB, mais pas RabbitMQ ou le provider d'emails)."]}),"\n",(0,l.jsx)(s.li,{children:"Dans la suite du livre l'auteur va plut\xf4t adopter l'approche classique, parce que c'est celle qu'il pr\xe9f\xe8re et celle qui est la plus courante."}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"3---the-anatomy-of-a-unit-test",children:"3 - The anatomy of a unit test"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Les tests unitaires doivent \xeatre structur\xe9s avec les 3 blocs Arrange, Act, Assert (qu'on appelle aussi Given, When , Then) :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Arrange"})," : Il peut \xeatre aussi gros que les deux autres sections r\xe9unies. S'il est plus gros, il est conseill\xe9 de l'extraire dans une fonction pour augmenter la lisibilit\xe9.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Avoir une m\xe9thode unique (constructeur de la classe de tests, ou ",(0,l.jsx)(s.code,{children:"beforeAll "}),"/ ",(0,l.jsx)(s.code,{children:"BeforeEach"})," global) est une moins bonne id\xe9e puisqu'on couple les tests ensemble, et que ce que poss\xe8de chaque test est moins clair."]}),"\n",(0,l.jsx)(s.li,{children:"L'id\xe9al c'est avoir des fonctions de type factory configurables, qu'on peut r\xe9utiliser dans les tests en sachant depuis le test \xe0 peu pr\xe8s ce qu'on cr\xe9e."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Act"})," : Il ne devrait faire qu'",(0,l.jsx)(s.strong,{children:"une ligne"})," vu qu'on est cens\xe9 v\xe9rifier une unit\xe9 de comportement. S'il fait plus, c'est qu'on a la possibilit\xe9 de faire une partie de la chose et pas l'autre, ce qui peut vouloir dire qu'on est en \xe9tat de ",(0,l.jsx)(s.strong,{children:"casser un invariant"}),", et donc qu'on a une mauvaise encapsulation de notre code.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Exemple : si notre act c'est deux lignes qui font :","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"customer"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".purchase"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(item);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"store"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".removeFromInventory"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(item);"})]})]})}),"\n","C'est que l'un peut \xeatre fait sans l'autre au niveau de l'interface publique (celle-l\xe0 m\xeame qui est test\xe9e). C'est un danger qu'on s'impose pour rien. Une seule m\xe9thode publique devrait faire les deux."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Assert"})," : Vu qu'on v\xe9rifie une unit\xe9 de comportement, il peut y avoir plusieurs outcomes, donc plusieurs asserts.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Attention quand m\xeame, si cette section grossit trop, c'est peut \xeatre le signe d'une mauvaise abstraction du code. Par exemple, si on doit comparer toutes les propri\xe9t\xe9s d'un objet un par un, et qu'on aurait pu impl\xe9menter l'op\xe9rateur d'\xe9galit\xe9 sur l'objet en question, et ne faire qu'un assert."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"On \xe9crit en g\xe9n\xe9ral d'abord la partie arrange si on a d\xe9j\xe0 \xe9crit le code, et d'abord la partie assert si on fait du TDD."}),"\n",(0,l.jsx)(s.li,{children:"Quand on teste plusieurs unit\xe9s de comportement, on se retrouve par d\xe9finition avec un test d'int\xe9gration. Il vaut mieux revenir sur de l'unitaire si possible."}),"\n",(0,l.jsxs)(s.li,{children:["Il faut ",(0,l.jsxs)(s.strong,{children:["\xe9viter les ",(0,l.jsx)(s.code,{children:"if"})," dans les tests"]}),". \xc7a complique la compr\xe9hension et la maintenance."]}),"\n",(0,l.jsxs)(s.li,{children:["Pour ",(0,l.jsx)(s.strong,{children:"rep\xe9rer facilement l'objet qu'on teste"}),", et ne pas le confondre avec des d\xe9pendances, l'auteur conseille d'appeler l'objet test\xe9 ",(0,l.jsx)(s.strong,{children:"sut"})," (pour System Under Test) :","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Arrange"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Calculator"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Act"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"result"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".sum"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"3"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"2"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Assert"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(result)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"5"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pour bien ",(0,l.jsx)(s.strong,{children:"s\xe9parer les 3 sections"})," AAA l'une de l'autre, l'auteur conseille :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Soit de laisser une ligne entre chaque section."}),"\n",(0,l.jsxs)(s.li,{children:["Soit, si certaines sections doivent d\xe9j\xe0 sauter des lignes parce qu'elles sont longues, de laisser en commentaire ",(0,l.jsx)(s.code,{children:"//Arrange"}),", ",(0,l.jsx)(s.code,{children:"//Act"})," et ",(0,l.jsx)(s.code,{children:"//Assert"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["A propos de la mani\xe8re de ",(0,l.jsx)(s.strong,{children:"nommer les tests"})," :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Vu que les tests testent un comportement, le nom des tests doit \xeatre une phrase, qui ",(0,l.jsx)(s.strong,{children:"a du sens pour les experts m\xe9tier"}),".","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Sauf dans le cas o\xf9 on teste des fonctions utilitaires, qui n'ont donc pas de sens pour les experts m\xe9tier."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Il faut \xe9viter de mettre le nom du SUT (la fonction test\xe9e) dans le nom du test. \xc7a oblige \xe0 changer le nom du test si le nom de la fonction change, et \xe7a n'apporte pas grand chose puisque c'est le comportement qui nous int\xe9resse."}),"\n",(0,l.jsxs)(s.li,{children:["Il vaut mieux ",(0,l.jsx)(s.strong,{children:"\xeatre sp\xe9cifique"})," dans le nom du test. Par exemple, si on teste qu'une date est invalide si elle est au pass\xe9, pr\xe9ciser \xe7a plut\xf4t que de rester vague en parlant simplement de v\xe9rifier si la date est valide."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["On peut utiliser les ",(0,l.jsx)(s.strong,{children:"tests param\xe9tris\xe9s"})," pour grouper des tests dont seule une valeur d'entr\xe9e et la valeur attendue change. Par exemple tester avec la date d'aujourd'hui, avec la date de demain, etc.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Attention quand m\xeame, faire ce genre de regroupement a un co\xfbt en lisibilit\xe9. Donc \xe0 faire que si les tests sont simples."}),"\n",(0,l.jsx)(s.li,{children:"Il faut \xe9viter de mettre dans le m\xeame test les cas positifs et les cas n\xe9gatifs."}),"\n",(0,l.jsx)(s.li,{children:"En g\xe9n\xe9ral, le framework de test fournit la possibilit\xe9 de param\xe9triser les tests, en acceptant une liste de param\xe8tres \xe0 faire varier en entr\xe9e du test."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"ii---making-your-tests-work-for-you",children:"II - Making your tests work for you"}),"\n",(0,l.jsx)(s.h3,{id:"4---the-four-pillars-of-a-good-unit-test",children:"4 - The four pillars of a good unit test"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Dans ce chapitre on pose des crit\xe8res pour ",(0,l.jsx)(s.strong,{children:"\xe9valuer la qualit\xe9 d'un test"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["Un bon test a 4 caract\xe9ristiques fondamentales :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsxs)(s.strong,{children:["1- Prot\xe9ger des r\xe9gressions ",(0,l.jsx)(s.strong,{children:": \xe9viter les bugs"}),"."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Pour \xe9valuer ce point on peut prendre en compte :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"La quantit\xe9 de code ex\xe9cut\xe9e : plus il y en a plus c'est fiable."}),"\n",(0,l.jsx)(s.li,{children:"La complexit\xe9 du code ex\xe9cut\xe9."}),"\n",(0,l.jsx)(s.li,{children:"L'importance du code : tester du code du domaine est plus utile que de tester du code utilitaire."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"2- R\xe9sister aux refactorings"})," : \xe0 quel point on peut refactorer sans casser le test.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Pour \xe9valuer ce crit\xe8re, on peut regarder si le test produit souvent des faux positifs pendant les refactorings."}),"\n",(0,l.jsxs)(s.li,{children:["L'int\xe9r\xeat de ce crit\xe8re c'est que si on a trop de faux positifs :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On porte de moins en moins attention au r\xe9sultat des tests puisqu'ils disent souvent n'importe quoi : et on laisse passer de vrais bugs."}),"\n",(0,l.jsx)(s.li,{children:"On n'ose plus refactorer le code, puisqu'on n'a pas confiance dans les tests. Et le code pourrit."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Ce qui fait casser les tests pendant les refactorings c'est souvent le ",(0,l.jsx)(s.strong,{children:"couplage aux d\xe9tails d'impl\xe9mentation"}),", au lieu de porter sur un comportement attendu du point de vue m\xe9tier.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Pour avoir une id\xe9e de ce que veut dire “tester les d\xe9tails d'impl\xe9mentation”, l'exemple le plus extr\xeame de ce genre serait un test qui v\xe9rifierait simplement que le code source de la fonction test\xe9e est bien le code source attendu dans le test. Ce test casserait litt\xe9ralement \xe0 chaque changement."}),"\n",(0,l.jsx)(s.li,{children:"Sans aller jusqu'\xe0 cet extr\xeame, on retrouve souvent des tests qui v\xe9rifient la structure interne d'un objet, ou qu'une fonction appelle telle ou telle autre fonction etc. sans que \xe7a n'ait aucun int\xe9r\xeat d'un point de vue m\xe9tier."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"3- Donner un feedback rapide"})," : \xe0 quel point on peut ex\xe9cuter le test vite.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Plus le test est lent, moins souvent on l'ex\xe9cutera."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"4- \xcatre maintenable"})," : il y a deux composantes :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"A quel point c'est difficile de comprendre le test. \xc7a d\xe9pend de la taille du test, de la lisibilit\xe9 de son code."}),"\n",(0,l.jsx)(s.li,{children:"A quel point c'est difficile de lancer le test. Par exemple \xe0 cause de la database qui doit \xeatre en train de tourner etc."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Les deux premiers piliers caract\xe9risent la pr\xe9cision (accuracy) du test.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"La protection contre les r\xe9gressions d\xe9pend de la capacit\xe9 \xe0 ne pas avoir de faux n\xe9gatifs (bugs pr\xe9sents mais rat\xe9s par les tests). C'est le fait d'avoir le bon signal."}),"\n",(0,l.jsx)(s.li,{children:"La r\xe9sistance aux refactorings d\xe9pend de la capacit\xe9 \xe0 ne pas avoir de faux positifs (fausses alarmes). C'est l'absence de bruit."}),"\n",(0,l.jsxs)(s.li,{children:["Au d\xe9but du projet, les faux positifs (les bugs pas couverts) ont la plus grande importance. Mais \xe0 mesure que le projet avance, les faux n\xe9gatifs deviennent de plus en plus g\xeanants et emp\xeachent de garder le code sain en le refactorant.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Donc si on est sur un projet moyen ou gros, il faut ",(0,l.jsx)(s.strong,{children:"porter une attention \xe9gale aux faux positifs et aux faux n\xe9gatifs"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["On peut noter un test sur chacun des 4 crit\xe8res, et lui ",(0,l.jsx)(s.strong,{children:"donner une note"})," finale qui nous aidera \xe0 ",(0,l.jsx)(s.strong,{children:"d\xe9cider si on le garde ou non"})," (pour rappel : garder un test n'est pas gratuit, \xe7a implique de la maintenance).","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["On peut \xe9valuer (subjectivement) la valeur du test \xe0 chacun des 4 crit\xe8res, entre 0 et 1, puis multiplier ces quatre valeurs pour avoir le r\xe9sultat final.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Ca implique donc qu'un test qui vaut z\xe9ro \xe0 l'un des crit\xe8res aura une valeur finale de z\xe9ro. On ne peut pas n\xe9gliger un des crit\xe8res."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["On ne peut malheureusement pas obtenir la note maximale partout, parce que les 3 premiers crit\xe8res ont un caract\xe8re exclusif entre eux : on ne peut en avoir que deux parfaits.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Les tests end to end, par exemple, maximisent la protection vis-\xe0-vis des r\xe9gressions parce qu'ils ex\xe9cutent beaucoup de code, et sont r\xe9sistants aux refactorings vu qu'ils testent depuis ce que voit l'utilisateur final. Par contre ils sont tr\xe8s lents."}),"\n",(0,l.jsx)(s.li,{children:"Et si on a des tests tr\xe8s rapides, en g\xe9n\xe9ral on n'obtiendra pas \xe0 la fois un d\xe9couplage et donc une r\xe9sistance aux refactorings, et en m\xeame temps une capacit\xe9 \xe0 arr\xeater tous les bugs."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["La r\xe8gle \xe0 retenir c'est que ",(0,l.jsx)(s.strong,{children:"la r\xe9sistance aux refactorings est non-n\xe9gociable"}),", pour la raison que ce crit\xe8re est assez binaire : soit on est bien d\xe9coupl\xe9, soit non. Et si on ne l'est pas, la valeur du test passe \xe0 z\xe9ro.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le choix qui reste c'est donc la possibilit\xe9 de faire varier le curseur entre la rapidit\xe9 du test, et sa capacit\xe9 \xe0 emp\xeacher les r\xe9gressions."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Si on examine notre ",(0,l.jsx)(s.strong,{children:"pyramide de tests"})," (unit, integration, e2e), on maximisera d'abord le crit\xe8re non-n\xe9gociable de r\xe9sistance aux refactorings pour tous, puis :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Les tests unitaires sont les plus rapides et prot\xe8gent le moins, puis on a les tests d'int\xe9gration qui sont au milieu, et les tests e2e sont tr\xe8s lents et prot\xe8gent le plus."}),"\n",(0,l.jsx)(s.li,{children:"En g\xe9n\xe9ral on a peu de tests e2e parce que leur extr\xeame lenteur diminue beaucoup leur valeur. Et ils sont aussi difficiles \xe0 maintenir."}),"\n",(0,l.jsx)(s.li,{children:"Pour les projets classiques on aura une pyramide, et pour les projets tr\xe8s simples (CRUD etc.), on pourra se retrouver avec un rectangle."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Le black-box testing consiste \xe0 tester sans prendre en compte la structure interne, seulement avec les consid\xe9rations business. Le white-box testing consiste \xe0 faire l'inverse.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le white-box testing menant \xe0 du code coupl\xe9 aux d\xe9tails d'impl\xe9mentations, il n'est pas r\xe9sistant aux refactorings, donc il ne faut pas l'utiliser (sauf pour analyser)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"5---mocks-and-test-fragility",children:"5 - Mocks and test fragility"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Il y a principalement deux types de ",(0,l.jsx)(s.strong,{children:"test doubles"})," :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["1- Les ",(0,l.jsx)(s.strong,{children:"mocks"})," qui aident \xe0 \xe9muler et examiner les ",(0,l.jsx)(s.strong,{children:"interactions sortantes"}),", c'est-\xe0-dire le cas o\xf9 le SUT interagit pour changer l'\xe9tat d'une de ses d\xe9pendances.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On pourrait voir le mock comme la commande du pattern CQS."}),"\n",(0,l.jsxs)(s.li,{children:["Il existe une petite distinction avec les ",(0,l.jsx)(s.strong,{children:"spies"})," qui sont des mocks \xe9crits \xe0 la main, alors que les mocks sont en g\xe9n\xe9ral g\xe9n\xe9r\xe9s par une librairie de mock."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["2- Les ",(0,l.jsx)(s.strong,{children:"stubs"})," qui aident \xe0 \xe9muler les ",(0,l.jsx)(s.strong,{children:"interactions entrantes"}),", c'est-\xe0-dire le cas o\xf9 une des d\xe9pendances fournit une valeur utilis\xe9e par le SUT.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On pourrait voir le stub comme la query du pattern CQS."}),"\n",(0,l.jsxs)(s.li,{children:["Il existe des sous ensemble de stubs :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["le ",(0,l.jsx)(s.strong,{children:"dummy"})," qui est tr\xe8s simple"]}),"\n",(0,l.jsxs)(s.li,{children:["le ",(0,l.jsx)(s.strong,{children:"stub"})," qui est plus sophistiqu\xe9, et retourne la bonne valeur en fonction du cas"]}),"\n",(0,l.jsxs)(s.li,{children:["et le ",(0,l.jsx)(s.strong,{children:"fake"})," qui est un stub utilis\xe9 pour remplacer un composant qui n'existe pas encore (typique de l'\xe9cole de Londres)."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Le mot mock peut vouloir dire plusieurs choses, ici on l'utilise pour sa d\xe9finition principale de sous ensemble de test double, mais parfois il est utilis\xe9 pour d\xe9signer tous les tests doubles, et parfois il d\xe9signe l'outil (la librairie qui permet de cr\xe9er des mocks et des stubs)."}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"V\xe9rifier les interactions sur des stubs est un antipattern"})," : les stubs \xe9mulent des donn\xe9es entrantes, et donc v\xe9rifier que le stub a bien \xe9t\xe9 appel\xe9 rel\xe8ve du couplage \xe0 des d\xe9tails d'impl\xe9mentation.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Les interactions ne doivent \xeatre v\xe9rifi\xe9es que sur des mocks, c'est-\xe0-dire des interactions sortantes, dans le cas o\xf9 l'appel qu'on v\xe9rifie a du sens d'un point de vue business."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["La distinction entre ",(0,l.jsx)(s.strong,{children:"comportement observable"})," et ",(0,l.jsx)(s.strong,{children:"d\xe9tail d'impl\xe9mentation"})," :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Il faut d'abord choisir le client qu'on consid\xe8re, puis v\xe9rifier si notre code lui permet :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Soit d'ex\xe9cuter une op\xe9ration pour faire un calcul ou un side effect pour atteindre ses objectifs."}),"\n",(0,l.jsx)(s.li,{children:"Soit d'utiliser un \xe9tat pour atteindre ses objectifs."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Si oui, alors on a un comportement observable, si non alors notre code est un d\xe9tail d'impl\xe9mentation."}),"\n",(0,l.jsx)(s.li,{children:"Le choix du client consid\xe9r\xe9 est important, on reviendra sur cet aspect dans la suite."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Si l'API publique co\xefncide avec le comportement observable, alors on dira que notre syst\xe8me est bien con\xe7u.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Sinon, on dira qu'il fait ",(0,l.jsx)(s.strong,{children:"fuiter des d\xe9tails d'impl\xe9mentation"}),". Parce que des d\xe9tails d'impl\xe9mentation pourront alors \xeatre acc\xe9d\xe9s de mani\xe8re publique sans protection (sans encapsulation).","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Exemple : Le cas o\xf9 le renommage de l'utilisateur se faisait en deux temps : renommer, puis appeler la fonction de normalisation qui coupe le nom \xe0 50 caract\xe8res max. Ici la fonction de normalisation ne permet d'atteindre aucun objectif du client qui l'appelle (il voulait juste renommer), pourtant elle est publique. On a donc un probl\xe8me de fuite."}),"\n",(0,l.jsx)(s.li,{children:"Un bon moyen de savoir si on fait fuiter des d\xe9tails d'impl\xe9mentation, c'est de voir les cas o\xf9 on a besoin de plus d'une op\xe9ration pour atteindre un objectif du client (le “act” du test)."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["L'",(0,l.jsx)(s.strong,{children:"architecture hexagonale"})," consiste en plusieurs hexagones communiquant entre eux.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Chaque hexagone est constitu\xe9 de deux couches :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Le ",(0,l.jsx)(s.strong,{children:"domain layer"})," qui n'a acc\xe8s qu'\xe0 lui-m\xeame et qui contient les r\xe8gles et invariants business de l'application.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Il est une collection de domain knowledge (how-to)."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["L'",(0,l.jsx)(s.strong,{children:"application service layer"})," qui orchestre la communication entre le domain layer et le monde externe. Elle instancie des classes import\xe9es du domain layer, leur donne les donn\xe9es qu'elle va chercher en base, les sauve \xe0 nouveau en base, r\xe9pond au client etc.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Elle est est une collection de use-cases business (what-to)."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Le terme hexagone est une image, chaque face repr\xe9sente une connexion \xe0 un autre hexagone, mais le nombre n'a pas besoin d'\xeatre 6."}),"\n",(0,l.jsxs)(s.li,{children:["Au sein de chaque couche, le client est la couche d'au-dessus, et donc ce sont ses objectifs qui sont pris en compte pour savoir si on lui expose des d\xe9tails d'impl\xe9mentation ou non.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Les objectifs du client final sont transcrits en objectifs secondaires dans la couche du dessous, et donc on a une relation fractale qui permet \xe0 ",(0,l.jsx)(s.strong,{children:"tous les tests d'avoir toujours un rapport avec un requirement business"})," (Les objectifs de l'application service layer sont des sous-objectifs du client final).","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"NDLR : un peu comme les OKR."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Exemple :","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// domain layer"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"setName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// On normalise et on set la valeur."})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// application service layer"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserController"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"renameUser"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"getUserFromDatabase"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".setName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newName);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"saveUserToDatabase"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(user);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pour savoir ",(0,l.jsx)(s.strong,{children:"quand utiliser les mocks"})," sans abimer la r\xe9sistance au refactoring, il faut se demander si l'interaction sortante qu'on veut v\xe9rifier est interne \xe0 notre application (notre hexagone par exemple), ou porte vers des syst\xe8mes externes.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Si l'interaction est ",(0,l.jsx)(s.strong,{children:"interne"}),", alors il ne faut pas mocker, m\xeame s'il s'agit d'une d\xe9pendance out-of-process comme une base de donn\xe9es. Tant qu'elle n'est visible que depuis notre application, elle est un d\xe9tail d'impl\xe9mentation pour nos clients."]}),"\n",(0,l.jsxs)(s.li,{children:["Si l'interaction est ",(0,l.jsx)(s.strong,{children:"externe"}),", et donc visible par nos clients externes, alors il faut v\xe9rifier qu'elle se fait correctement par un mock. Par exemple, l'envoi d'un email r\xe9pond \xe0 un besoin client, donc il faut v\xe9rifier que l'appel vers le syst\xe8me externe se fait correctement."]}),"\n",(0,l.jsx)(s.li,{children:"Pour parler un peu des \xe9coles : l'\xe9cole de Londres pr\xe9conise de mocker toutes les d\xe9pendances mutables, \xe7a fait beaucoup trop de mocks. Mais l'\xe9cole classique pr\xe9conise de mocker aussi des choses en trop : typiquement la base de donn\xe9es qui est une shared dependency. On peut au lieu de mocker nos interactions avec elle, la remplacer intelligemment par autre choses dans nos tests (cf. les deux prochains chapitres)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"6---styles-of-unit-testing",children:"6 - Styles of unit testing"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Il y a 3 “styles” de tests :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Output-based"})," : c'est quand il n'y a pas de side effect, et qu'on teste une fonction qui prend des param\xe8tres, et renvoie quelque chose. Il s'agit de fonction pure, donc de programmation fonctionnelle."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"State-based"})," : on fait une op\xe9ration, et on v\xe9rifie l'\xe9tat d'un objet."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Communication-based"})," : on utilise des mocks pour v\xe9rifier qu'un appel \xe0 une fonction a \xe9t\xe9 fait avec les bons param\xe8tres."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"A propos des \xe9coles de test :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"L'\xe9cole classique pr\xe9f\xe8re le state-based plut\xf4t que la communication based."}),"\n",(0,l.jsx)(s.li,{children:"L'\xe9cole de Londres fait le choix inverse."}),"\n",(0,l.jsx)(s.li,{children:"Et toutes les deux utilisent l'output-based testing quand c'est possible."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"On peut comparer les 3 styles de test vis-\xe0-vis des 4 crit\xe8res d'un bon test :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Pour la protection contre les r\xe9gressions et la rapidit\xe9 de feedback les 3 styles se valent \xe0 peu pr\xe8s."}),"\n",(0,l.jsxs)(s.li,{children:["Concernant la r\xe9sistance au refactoring :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"L'output-based testing offre la meilleure r\xe9sistance parce que la fonction se suffit \xe0 elle-m\xeame."}),"\n",(0,l.jsx)(s.li,{children:"Le state-based testing est un peu moins r\xe9sistant parce que l'API publique expos\xe9e est plus importante, et donc les chances de faire fuiter des d\xe9tails d'impl\xe9mentation dans la partie publique sont plus grandes."}),"\n",(0,l.jsx)(s.li,{children:"Le communication-based testing est le plus fragile, et n\xe9cessite une grande rigueur pour ne pas coupler \xe0 des d\xe9tails d'impl\xe9mentation."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Concernant la maintenabilit\xe9 : c'est \xe0 nouveau l'output-based qui est le plus maintenable parce que prenant le moins de place, suivi du state-based, et enfin du communication-based qui prend beaucoup de place avec ses mocks et stubs."}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Globalement l'output-based testing est le meilleur"}),", mais il n\xe9cessite d'avoir du code \xe9crit de mani\xe8re fonctionnelle."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"A propos de la programmation fonctionnelle, l'auteur conseille les livres de Scott Wlaschin."}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Pour pouvoir faire de l'output-based testing, il faut \xe9crire du code avec des ",(0,l.jsx)(s.strong,{children:"fonctions pures"}),", c'est-\xe0-dire qui renvoient le m\xeame r\xe9sultat \xe0 chaque fois qu'on donne les m\xeames param\xe8tres, sans qu'il n'y ait d'inputs ou d'outputs cach\xe9s."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Parmi ces choses cach\xe9es, on a :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Les ",(0,l.jsx)(s.strong,{children:"side-effects"})," : des outputs cach\xe9s, par exemple la modification d'un \xe9tat d'une classe, l'\xe9criture dans un fichier etc."]}),"\n",(0,l.jsxs)(s.li,{children:["Les ",(0,l.jsx)(s.strong,{children:"exceptions"})," : elles cr\xe9ent un chemin alternatif \xe0 celui de la fonction, et peuvent \xeatre trait\xe9es n'importe o\xf9 dans la stack d'appel."]}),"\n",(0,l.jsxs)(s.li,{children:["La ",(0,l.jsx)(s.strong,{children:"r\xe9f\xe9rence \xe0 un \xe9tat"})," interne ou externe : un input cach\xe9 qui va permettre de r\xe9cup\xe9rer une valeur qui n'est pas indiqu\xe9e dans la signature de la fonction."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pour savoir si on a une fonction pure, on peut essayer de remplacer son appel par la valeur qu'elle devrait renvoyer, et v\xe9rifier que le programme ne change pas de comportement. Si oui on a une ",(0,l.jsx)(s.em,{children:"referential transparency"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["L'",(0,l.jsx)(s.strong,{children:"architecture fonctionnelle"})," consiste \xe0 maximiser la quantit\xe9 de code \xe9crite de mani\xe8re fonctionnelle (fonctions pures, avec valeurs immutables), et confiner le code qui fait les side-effects \xe0 un endroit bien pr\xe9cis."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["1- Il y a le code qui prend les d\xe9cisions, qui est sous forme de fonctions pures. C'est le ",(0,l.jsx)(s.strong,{children:"functional core"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["2- Et le code qui agit suite aux d\xe9cisions, qui prend les inputs et cr\xe9e les side-effects (UI, DB, message bus etc.). C'est le ",(0,l.jsx)(s.strong,{children:"mutable shell"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"On va couvrir le functional core par de nombreux tests unitaires output-based, et couvrir le mutable shell qui est la couche d'au-dessus par des tests d'int\xe9gration moins nombreux."}),"\n",(0,l.jsxs)(s.li,{children:["L'architecture fonctionnelle est en fait un ",(0,l.jsx)(s.strong,{children:"cas particulier de l'architecture hexagonale"})," :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Les deux ont bien deux couches organis\xe9es par inversion de d\xe9pendance."}),"\n",(0,l.jsx)(s.li,{children:"La diff\xe9rence principale c'est que l'architecture fonctionnelle exclut tout side-effect du functional core vers le mutable shell, alors que l'architecture hexagonale permet les side-effects dans la couche domaine tant que \xe7a n'agit pas au-del\xe0 de cette couche (DB par exemple)."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Exemple d'application peu testable, refactor\xe9e vers la functional architecture :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Description :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On a un syst\xe8me d'audit qui enregistre tous les visiteurs d'une organisation."}),"\n",(0,l.jsx)(s.li,{children:"Le nom de chaque visiteur et la date sont ajout\xe9s \xe0 un fichier de log."}),"\n",(0,l.jsx)(s.li,{children:"Quand le nombre de lignes max du fichier est atteint, on \xe9crit dans un autre fichier."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Initialement la classe ",(0,l.jsx)(s.code,{children:"AuditManager"})," a une m\xe9thode ",(0,l.jsx)(s.code,{children:"addRecord()"})," qui va lire les fichiers existants, les classer pour trouver le dernier. Puis v\xe9rifier s'il est plein pour soit \xe9crire dedans, soit \xe9crire dans dans un nouveau."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.strong,{children:"La logique et la lecture/\xe9criture sont dans la m\xeame fonction"}),". Donc les tests vont \xeatre \xe0 la fois lents, et difficiles \xe0 parall\xe9liser \xe0 cause de la d\xe9pendance out-of-process partag\xe9e qu'est le filesystem."]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"AuditManager"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" maxEntriesPerFile"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" directoryName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ) {}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"addRecord"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(visitorName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" timeOfVisit"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Date"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Get all files in the given directory"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fs"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"require"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'fs'"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"files"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fs"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".readdirSync"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(directoryName);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Build the record content"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If no file, create one with our record"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fs"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".writeFile"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"..."})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Sort by file name to get the last one"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If file's lines do no exceed max, write inside"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Otherwise create a new file and write inside"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Une 1\xe8re \xe9tape est d'",(0,l.jsx)(s.strong,{children:"utiliser des mocks"})," pour d\xe9coupler le filesystem de la logique :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Une des mani\xe8res de faire \xe7a c'est d'injecter un objet qui respecte une interface ",(0,l.jsx)(s.code,{children:"IFileSystem"}),", qui sera soit le vrai filesystem, soit un mock dans les tests."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Le mock va \xe0 la fois servir de stub pour renvoyer le contenu des fichiers, et aussi de mock pour v\xe9rifier qu'on appelle bien la bonne fonction avec les bons param\xe8tres pour \xe9crire dans le filesystem. L'usage du mock ici est l\xe9gitime parce que ces fichiers sont user-facing."}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"AuditManager"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" maxEntriesPerFile"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" directoryName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" fileSystem"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"IFileSystem"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ) {}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"addRecord"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(visitorName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" timeOfVisit"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Date"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"files"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fileSystem"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".readdirSync"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(directoryName);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Build the record content"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If no file, create one with our record"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fileSystem"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".writeFile"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"..."})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Sort by file name to get the last one"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If file's lines do no exceed max, write inside"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Otherwise create a new file and write inside"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"it"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"creates a new file when the current file overflows"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" () "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fileSystemMock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"IFileSystem"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"readdirSync"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" () "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ["}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"audits/audit_1.txt"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"audits/audit_2.txt"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"]"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    writeFile"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"jest"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".fn"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"()"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// ..."})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  };"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"AuditManager"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"3"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"audits"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" fileSystemMock);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".addRecord"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Alice"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Date"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2019-04-06"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"));"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fileSystemMock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".writeFile)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toHaveBeenCalledTimes"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fileSystemMock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".writeFile)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toHaveBeenCalledWith"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"audits/audit_3.txt"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Alice; 2019-04-06"'})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  );"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"});"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"On n'a rien chang\xe9 \xe0 la protection contre les r\xe9gressions et \xe0 la r\xe9sistance aux refactorings. Par contre on a rendu les tests plus rapides, et on a un peu am\xe9lior\xe9 la maintenabilit\xe9 parce qu'on n'a plus \xe0 se pr\xe9occuper du filesystem. Mais le setup des mocks est verbeux, on peut faire mieux sur la maintenabilit\xe9."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["La 2\xe8me \xe9tape est de ",(0,l.jsx)(s.strong,{children:"refactorer vers la functional architecture"})," :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.code,{children:"AuditManager"})," ne conna\xeet plus du tout l'existence du filesystem : il re\xe7oit des valeurs en entr\xe9e (une liste de ",(0,l.jsx)(s.code,{children:"FileContent"})," \xe0 partir duquel il lira le contenu des fichiers), et renvoie des valeurs en sortie : une liste de ",(0,l.jsx)(s.code,{children:"FileUpdate"})," qui contiendront les contenus \xe0 changer)."]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"AuditManager"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" maxEntriesPerFile"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {}"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"addRecord"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    files"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileContent"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[]"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    visitorName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    timeOfVisit"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Date"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  ) {"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Build the record content"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If no file, create one with our record"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"files"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"length"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"==="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileUpdate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"audit_1.txt"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newRecord);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Sort by file name to get the last one"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If file's lines do no exceed max, write inside"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Otherwise create a new file and write inside"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileContent"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" fileName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" lines"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[]) {}"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileUpdate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" fileName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newContent"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {}"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["On a une classe ",(0,l.jsx)(s.code,{children:"Persister"})," qui va permettre de lire tous les fichiers, et de renvoyer leurs informations sous forme de ",(0,l.jsx)(s.code,{children:"FileContent"}),", et une autre m\xe9thode pour prendre une liste de ",(0,l.jsx)(s.code,{children:"FileUpdate"}),", et les appliquer sur le filesystem. Il doit \xeatre le plus simple possible pour que le max de logique soit dans ",(0,l.jsx)(s.code,{children:"AuditManager"}),"."]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fs"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"require"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"fs"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Persister"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"readDirectory"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(directoryName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileContent"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[] {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fs"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".readdirSync"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(directoryName)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".map"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"((file) "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileContent"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"file"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".name"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"file"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".lines);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    });"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"applyUpdate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(filePath"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" update"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileUpdate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"fs"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".writeFile"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(filePath"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" update);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Pour faire fonctionner ensemble le functional core (",(0,l.jsx)(s.code,{children:"AuditManager"}),"), et le mutable shell (",(0,l.jsx)(s.code,{children:"Persister"}),"), on a besoin d'une autre classe de type “application service” (pour utiliser la terminologie de l'hexagonal architecture)."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Il va manipuler manipuler ",(0,l.jsx)(s.code,{children:"Persister"})," pour obtenir les donn\xe9es des fichiers, les donner \xe0 une instance d'",(0,l.jsx)(s.code,{children:"AuditManager"}),", puis appeler la m\xe9thode de calcul sur ",(0,l.jsx)(s.code,{children:"AuditManager"}),", r\xe9cup\xe9rer les commandes d'\xe9criture en sortie, et les donner \xe0 ",(0,l.jsx)(s.code,{children:"Persister"})," pour mettre \xe0 jour le filesystem."]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"ApplicationService"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" directoryName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" maxEntriesPerFile"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".auditManager "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"AuditManager"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(maxEntriesPerFIle);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".persister "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Persister"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"addRecord"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(visitorName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" timeOfVisit"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Date"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"files"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileContent"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[] "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"persister"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".readDirectory"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".directoryName"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    );"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"update"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileUpdate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"auditManager"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".addRecord"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      files"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      visitorName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      timeOfVisit"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    );"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"persister"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".applyUpdate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".directoryName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" update);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["On a gard\xe9 les pr\xe9c\xe9dents avantages, et on a am\xe9lior\xe9 la maintenabilit\xe9 en \xe9liminant le setup de mocks verbeux, remplac\xe9s par la simple instanciation de valeurs mis dans les objets ",(0,l.jsx)(s.code,{children:"FileContent"})," et ",(0,l.jsx)(s.code,{children:"FileUpdate"}),"."]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"it"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"creates a new file when the current file overflows"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" () "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"AuditManager"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"3"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"files"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ["})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileContent"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"audits/audit_1.txt"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" [])"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"FileContent"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"audits/audit_1.txt"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ["})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Peter; 2019-04-06"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Jane; 2019-04-06"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Jack; 2019-04-06"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ])"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  ];"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"update"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".addRecord"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(files"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Alice"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Date"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2019-04-06"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"));"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"update"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".fileName)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"audit_3.txt"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"update"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".newContent)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Alice; 2019-04-06"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"});"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Pour rester sur du fonctionnel, on peut renvoyer les erreurs par valeur de retour, et d\xe9cider de quoi en faire dans l'application service."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.strong,{children:"La functional architecture n'est pas toujours applicable"}),"."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Elle permet d'avoir des avantages en termes de maintenabilit\xe9 du code et des tests, mais elle a des d\xe9savantages :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Le code pourra ",(0,l.jsx)(s.strong,{children:"\xeatre un peu plus gros"})," pour permettre la s\xe9paration entre logique et side effects."]}),"\n",(0,l.jsxs)(s.li,{children:["Le code pourra ",(0,l.jsx)(s.strong,{children:"souffrir de probl\xe8mes de performance"}),".","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Dans notre cas, \xe7a a march\xe9 parce qu'on lisait tous les fichiers avant d'appeler la logique en donnant tous ces contenus et la laissant d\xe9cider. Si on avait voulu n'en lire que certains en fonction de param\xe8tres d\xe9cid\xe9s par la logique, on n'aurait pas pu la garder comme fonction pure."}),"\n",(0,l.jsx)(s.li,{children:"Une autre solution aurait pu \xeatre de conc\xe9der un peu de centralisation de la logique dans le core en faveur de la performance, en laissant la d\xe9cision de charger les donn\xe9es ou non \xe0 l'application service."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Il faut donc ",(0,l.jsx)(s.strong,{children:"appliquer la functional architecture strat\xe9giquement"}),".","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Ne pas sacrifier la performance si elle est importante dans le projet."}),"\n",(0,l.jsx)(s.li,{children:"L'appliquer si le projet est cens\xe9 durer dans le long terme, et que l'investissement initial de s\xe9parer en vaut la peine."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"En g\xe9n\xe9ral (surtout si on fait de l'OOP), on aura une combinaison de tests state-based et output-based, et quelques tests communication-based."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le conseil ici c'est de privil\xe9gier les tests output-based quand c'est raisonnablement possible."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"7---refactoring-toward-valuable-unit-tests",children:"7 - Refactoring toward valuable unit tests"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Les tests et le code sont profond\xe9ment li\xe9s, il est impossible d'obtenir de ",(0,l.jsx)(s.strong,{children:"bons tests avec du mauvais code"}),"."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"On va cat\xe9goriser le code en 4 cat\xe9gories, en fonction de 2 axes :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["L'axe de ",(0,l.jsx)(s.strong,{children:"complexit\xe9 ou d'importance vis-\xe0-vis du domaine"}),".","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["La complexit\xe9 cyclomatique est d\xe9finie par le nombre de branches possibles dans le code : 1 + le nombre de branches.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le calcul tient compte du nombre de pr\xe9dicats dans les conditions : si notre if v\xe9rifie 2 pr\xe9dicats, \xe7a ajoute 2 points."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"L'importance vis-\xe0-vis du domaine c'est la connexion du code avec le besoin de l'utilisateur final. Du code utilitaire ne rentrera pas l\xe0-dedans."}),"\n",(0,l.jsxs)(s.li,{children:["C'est la complexit\xe9 ",(0,l.jsx)(s.strong,{children:"ou"})," l'importance domaine. Un code signifiant du point de vue du domaine mais simple rentre dans la description."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["L'axe du ",(0,l.jsx)(s.strong,{children:"nombre de collaborators"})," impliqu\xe9s.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Pour rappel un collaborator est une d\xe9pendance, qui est soit mutable (autre chose que des valeurs primitives et des value objects), soit out-of-process."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Les 4 cat\xe9gories de code sont :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Domain models and algorithms"})," : grande valeur sur l'axe de complexit\xe9, faible valeur sur l'axe des collaborators.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"C'est eux qu'il faut le plus tester, \xe0 la fois parce qu'ils sont faciles \xe0 tester et parce qu'on obtiendra une grande r\xe9sistance aux r\xe9gressions. C'est d'eux qu'on obtient le meilleur “retour sur investissement” de nos tests."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Trivial code"})," : faible valeur sur les deux axes.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"C'est du code simple, qui ne m\xe9rite pas de tests."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Controllers"})," : faible valeur sur l'axe de complexit\xe9, grande valeur sur l'axe des collaborators.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Il s'agit de code pas complexe mais qui coordonne le code complexe ou important."}),"\n",(0,l.jsx)(s.li,{children:"On peut les tester avec des tests d'int\xe9gration qui seront beaucoup moins nombreux que les unit tests des domain models and algorithms."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Overcomplicated code"})," : grande valeur sur les deux axes.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"L\xe0 on est emb\xeat\xe9 : c'est \xe0 la fois du code qu'on ne peut pas se permettre de ne pas tester, et du code difficile \xe0 tester. Par exemple des fat controllers qui font tout eux-m\xeames."}),"\n",(0,l.jsx)(s.li,{children:"On va chercher \xe0 se d\xe9barrasser de ce code en le d\xe9coupant, pour obtenir du code qui score beaucoup sur l'un des axes mais jamais les deux."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Le ",(0,l.jsx)(s.strong,{children:"Humble Object Pattern"})," va nous permettre de d\xe9coupler la logique de la partie difficile \xe0 tester (par difficile on entend code asynchrone/multi-thread, UI, d\xe9pendances out-of-process etc.)."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le test va tester la partie logique complexe/m\xe9tier directement."}),"\n",(0,l.jsx)(s.li,{children:"Le humble object est une fine couche avec tr\xe8s peu de logique, qui va lier la logique et la d\xe9pendance qui pose probl\xe8me dans les tests."}),"\n",(0,l.jsx)(s.li,{children:"Il s'agit de dire qu'un code doit soit avoir une grande complexit\xe9 (domain layer and algorithms), soit travailler avec beaucoup de d\xe9pendances (controllers), mais jamais les deux."}),"\n",(0,l.jsxs)(s.li,{children:["Exemples :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"La functional et l'hexagonal architecture utilisent le humble object pattern."}),"\n",(0,l.jsx)(s.li,{children:"On peut aussi mettre dans cette cat\xe9gorie les patterns MVC et MVP qui s\xe9parent la logique (le mod\xe8le) de la UI (view), avec le humble object (le presenter ou le controller)."}),"\n",(0,l.jsxs)(s.li,{children:["L'aggregate du DDD est aussi un exemple : on groupe les classes dans des clusters (les aggregates) o\xf9 elles auront une forte connectivit\xe9, et les clusters auront une faible connectivit\xe9 entre eux. Ca permet de faciliter la testabilit\xe9 en ayant besoin d'instancier essentiellement les collaborators du cluster concern\xe9.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"NDLR : que l'aggregate permette d'am\xe9liorer la testabilit\xe9 ou la maintenabilit\xe9 OK, mais j'arrive pas \xe0 voir le rapport avec le humble object pattern ici. On n'a pas de hard-to-test dependency."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Exemple d'application avec du code overcomplicated, refactor\xe9e vers du humble object pattern :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Description :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On a un CRM qui g\xe8re les utilisateurs, et les stocke en DB."}),"\n",(0,l.jsx)(s.li,{children:"La seule fonctionnalit\xe9 dispo c'est le changement d'email : si le nom de domaine du nouvel email appartient \xe0 l'entreprise le user est un employ\xe9, sinon il devient un customer."}),"\n",(0,l.jsx)(s.li,{children:"En fonction des emails des users, et donc de leur statut, le nombre d'employ\xe9s est calcul\xe9 et mis en base."}),"\n",(0,l.jsx)(s.li,{children:"Quand le changement d'email est fait, on doit envoyer un message dans un message bus."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["La 1\xe8re impl\xe9mentation contient une classe ",(0,l.jsx)(s.code,{children:"User"}),", avec une m\xe9thode ",(0,l.jsx)(s.code,{children:"changeEmail()"})," qui calcule le nouveau statut du user, et sauve son email en base, mais aussi recalcule et sauve le nouveau nombre d'employ\xe9s dans la table de l'entreprise. Elle envoie aussi le message dans le message bus."]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" type"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserType"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  ) {}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Get user data from database"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If new email is same as before, return"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Get company data from database"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Check whether the email is corporate"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Set the user type accordingly"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If the type is different, update company number"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// of employees."})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Save user info in database"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Save company info in database"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Send message to message bus"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Notre m\xe9thode ",(0,l.jsx)(s.code,{children:"changeEmail()"})," fait des choses importantes du point de vue domaine, mais en m\xeame temps elle a deux collaborators out-of-process (la DB et le message bus), ce qui est un no-go pour du code compliqu\xe9 ou avec importance domaine."]}),"\n",(0,l.jsx)(s.li,{children:"On est en pr\xe9sence du pattern Active Record : la classe domaine se query et se persiste en DB directement. C'est OK pour du code simple, mais pas pour du code qui va cro\xeetre sur le long terme."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Possibilit\xe9 1 : rendre explicites les d\xe9pendances implicites, en donnant l'objet de DB et message bus en param\xe8tre (ce qui permettra de les mocker dans les tests)."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Que les d\xe9pendances soient directes ou via une interface, \xe7a ne change rien au statut du code : il reste overcomplicated."}),"\n",(0,l.jsx)(s.li,{children:"On va devoir mettre en place une m\xe9canique de mocks complexe pour les tests. On peut trouver plus clean que \xe7a."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Possibilit\xe9 2, \xe9tape 1 : ",(0,l.jsx)(s.strong,{children:"introduire un application service"})," (humble object) qu'on appelle ",(0,l.jsx)(s.code,{children:"UserController"})," pour prendre la responsabilit\xe9 de la communication avec les d\xe9pendances out-of-process."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"La nouvelle classe va chercher les informations du user et de l'entreprise en DB, cr\xe9e un objet User avec ces infos. Puis elle appelle user.changeEmail(), et enfin sauve les donn\xe9es du user et de l'entreprise en DB, et envoie l'event d'email chang\xe9 dans le message bus."}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserController"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" database"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Database"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" messageBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"MessageBus"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  ) {}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Get user data from database"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Get company data from database"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" type);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"numberOfEmployees"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      companyDomainName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      numberOfEmployees"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    );"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Save user info in database"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Save company info in database"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Send message to message bus"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// ..."})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    companyDomainName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    numberOfEmployees"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If new email is same as before, return"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Check whether the email is corporate"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Set the user type accordingly"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"newType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"..."})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If the type is different, update company number"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// of employees."})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    numberOfEmployees "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"..."})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".email "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail;"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".type "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newType;"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" numberOfEmployees;"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Probl\xe8mes :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On a une logique complexe dans le fait de reconstruire les donn\xe9es \xe0 partir de la base de donn\xe9es (le mapping), c'est le travail d'un ORM."}),"\n",(0,l.jsx)(s.li,{children:"L'event de changement d'email est envoy\xe9 syst\xe9matiquement, m\xeame si l'email n'a pas \xe9t\xe9 chang\xe9."}),"\n",(0,l.jsxs)(s.li,{children:["On a un petit code smell : la m\xe9thode ",(0,l.jsx)(s.code,{children:"user.changeEmail()"})," prend le nombre d'employ\xe9s en param\xe8tre, et renvoie le nouveau nombre d'employ\xe9s. \xc7a n'a rien \xe0 voir avec un user donn\xe9."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Mais au moins la classe ",(0,l.jsx)(s.code,{children:"User"})," a perdu ses collaborators, elle est donc en l'\xe9tat purement fonctionnelle. On va pouvoir la tester \xe0 fond facilement."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["\xc9tape 2 : ",(0,l.jsx)(s.strong,{children:"enlever de la complexit\xe9 de l'application service"}),"."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Pour faire le mapping entre les donn\xe9es de la DB et un objet en m\xe9moire, on va soit utiliser un ORM, soit cr\xe9er nous-m\xeames un objet de type factory qui va renvoyer notre ",(0,l.jsx)(s.code,{children:"User"}),"."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Cette logique a l'air simple avec peu de branches apparentes, mais il faut prendre en compte les branches cach\xe9s li\xe9s aux d\xe9pendances : on fait des conversions de type, on va chercher des objets inconnus dans un tableau un \xe0 un etc. beaucoup de choses peuvent mal aller dans ce processus."}),"\n"]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserFactory"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"create"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(data"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Record"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"&"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"lt"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"any"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" any>) {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"Precondition"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".requires"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"data"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"length"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:">="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"3"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"id"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" data["}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"];"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" data["}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"];"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"type"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" data["}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"2"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"];"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(id"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" type);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On a ici du code utilitaire complexe."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["A la fin de l'\xe9tape on a bien ",(0,l.jsx)(s.code,{children:"User"})," qui est dans la case “domain models and algorithms”, et ",(0,l.jsx)(s.code,{children:"UserController"})," qui est dans la case “Controllers”. Il n'y a plus d'overcomplicated code."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["\xc9tape 3 : on introduit une nouvelle classe domaine ",(0,l.jsx)(s.code,{children:"Company"}),"."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Notre nouvelle classe domaine ",(0,l.jsx)(s.code,{children:"Company"})," peut r\xe9cup\xe9rer la logique de calcul du nombre d'employ\xe9s qu'on sort de ",(0,l.jsx)(s.code,{children:"User"}),"."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["On a donc ",(0,l.jsx)(s.code,{children:"UserController"})," qui cr\xe9e les deux objets de domaine \xe0 partir des donn\xe9es de la DB, et qui appelle ",(0,l.jsx)(s.code,{children:"user.changeEmail()"})," en donnant l'instance ",(0,l.jsx)(s.code,{children:"company"})," en param\xe8tre."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["On a un principe important d'encapsulation OO ici : ",(0,l.jsx)(s.strong,{children:"tell, don't ask"}),". Le user va dire (tell) \xe0 l'instance de company de mettre \xe0 jour elle-m\xeame son nombre d'employ\xe9s, plut\xf4t que lui demander (ask) ses donn\xe9es brutes et faisant l'op\xe9ration \xe0 sa place."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.code,{children:"user.changeEmail()"})," n'est plus une fonction pure puisqu'elle a un collaborator (company), mais vu qu'il n'y en a qu'un et qu'il n'est pas out-of-process, c'est raisonnable."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On va donc devoir faire du state-based testing, l'output-based \xe9tant possible qu'avec des fonctions pures."}),"\n"]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" domainName"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" numberOfEmployees"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  ) {}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeNumberOfEmployees"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(delta"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"Precondition"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".requires"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".nomberOfEmployees "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"+"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" delta "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:">="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".numberOfEmployees "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"+="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" delta;"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"isEmailCorporate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Get the domain part from the email"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// and return whether it is equal to this.domainName"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// ..."})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (newEmail "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"==="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".email) "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"newType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".isEmailCorporate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newEmail)"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"?"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"Usertype"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".Employee"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"Usertype"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".Customer;"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// If the type is different, update company number"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// of employees."})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".changeNumberOfEmployees"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(delta);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".email "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail;"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".type "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newType;"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserController"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"constructor"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" database"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Database"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" messageBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"MessageBus"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  ) {}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"userData"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"database"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".getUserById"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"UserFactory"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".create"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userData);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"companyData"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"database"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".getCompany"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"CompanyFactory"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".create"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(companyData);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" company);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"database"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".saveCompany"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(company);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"database"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".saveUser"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(user);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"messageBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".sendEmailChangedMessage"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["A la fin, user et company sont sauv\xe9s en DB, et l'event est envoy\xe9 dans le message bus par ",(0,l.jsx)(s.code,{children:"UserController"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Comment ",(0,l.jsx)(s.strong,{children:"tester"})," notre exemple refactor\xe9 ?"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Le code des classes domaine (User et Company), et le code utilitaire complexe (factory si on n'a pas utilis\xe9 d'ORM) peuvent \xeatre unit test\xe9s \xe0 fond."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Exemple : ",(0,l.jsx)(s.code,{children:'"changement d\'email de corporate \xe0 non corporate"'}),", ",(0,l.jsx)(s.code,{children:'"changement d\'email de non corporate \xe0 corporate"'}),", ",(0,l.jsx)(s.code,{children:'"changement d\'email au m\xeame email"'})," etc."]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"it"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"changes email from non corporate to corporate"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" () "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"mycorp.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"user@gmail.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"UserType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".Customer);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"new@mycorp.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" company);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".numberOfEmployees)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"2"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".email)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"new@mycorp.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".userType)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toEqual"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"UserType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".Employee);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"});"})})]})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Les m\xe9thodes ultra simples comme le constructeur de User n'ont pas \xe0 \xeatre test\xe9es."}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Le controller doit \xeatre test\xe9 avec des tests d'int\xe9gration moins nombreux. Ce sera l'objet des prochains chapitres."}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Les pr\xe9-conditions sont des checks qui permettent de throw une exception t\xf4t si une incoh\xe9rence est d\xe9tect\xe9e, pour \xe9viter des probl\xe8mes plus importants."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Ces ",(0,l.jsx)(s.strong,{children:"pr\xe9-conditions doivent \xeatre test\xe9es seulement si elles ont un lien avec le domaine"}),", sinon c'est pas la peine."]}),"\n",(0,l.jsxs)(s.li,{children:["Exemple de pr\xe9-condition qu'on teste : la m\xe9thode qui permet de mettre \xe0 jour le nombre d'employ\xe9s sur ",(0,l.jsx)(s.code,{children:"Company"})," throw si le nombre souhait\xe9 est inf\xe9rieur \xe0 0."]}),"\n",(0,l.jsx)(s.li,{children:"Exemple de pr\xe9-condition \xe0 ne pas tester : notre user factory v\xe9rifie que les donn\xe9es venant de la base ont bien 3 \xe9l\xe9ments avant de reconstruire le user. Cette v\xe9rification n'a pas de sens d'un point de vue domaine."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Notre d\xe9coupage domaine/controller marche bien parce qu'on r\xe9cup\xe8re l'ensemble des donn\xe9es upfront, et les sauve \xe0 la fin en base inconditionnellement dans le controller. Mais ",(0,l.jsx)(s.strong,{children:"que faire si on a besoin d'acc\xe8s \xe0 des donn\xe9es seulement dans certains cas dict\xe9s par la logique"})," ?"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Il y a des trade-offs \xe0 faire en fonction de :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"la testabilit\xe9 du code du domaine"}),"\n",(0,l.jsx)(s.li,{children:"la simplicit\xe9 du code du controller"}),"\n",(0,l.jsx)(s.li,{children:"la performance"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["On a 3 possibilit\xe9s :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Garder toute la logique dans le domaine, et toute l'interaction avec les deps out-of-process dans le controller"}),".","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Dans ce cas on va avoir une moins bonne performance, puisqu'on fera la lecture de la donn\xe9e dont on n'aura peut-\xeatre pas besoin \xe0 l'avance syst\xe9matiquement. Le controller n'ayant pas la connaissance de si on a besoin ou non, il prend la donn\xe9e et la donne tout le temps."}),"\n",(0,l.jsx)(s.li,{children:"Par contre on a un code de domaine testable, et un controller simple."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Injecter les d\xe9pendances out-of-process dans le domaine"}),", et laisser le code business d\xe9cider quand r\xe9cup\xe9rer ou non les donn\xe9es.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le souci ici c'est la maintenabilit\xe9 des tests du domaine, avec soit des tests lents \xe0 travers la DB, soit des mocks compliqu\xe9s \xe0 maintenir."}),"\n",(0,l.jsx)(s.li,{children:"Par contre on a un controller simple, et de la performance."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"D\xe9couper le processus de d\xe9cision en plusieurs parties"}),".","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le controller va appeler la 1\xe8re partie, r\xe9cup\xe9rer les donn\xe9es, puis d\xe9cider lui-m\xeame s'il faut faire la deuxi\xe8me partie. Si oui il r\xe9cup\xe8re les donn\xe9es additionnelles depuis la DB, et ex\xe9cute la 2\xe8me partie. Et \xe0 la fin comme d'habitude sauve le tout en DB."}),"\n",(0,l.jsx)(s.li,{children:"Une partie de la logique risque de fuiter du domaine vers le controller et rendre le controller plus compliqu\xe9."}),"\n",(0,l.jsx)(s.li,{children:"Par contre on a le code du domaine testable, et on garde la performance."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["La plupart du temps, ",(0,l.jsx)(s.strong,{children:"c\xe9der sur la performance n'est pas possible"}),".","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Il nous reste donc les 2 derni\xe8res possibilit\xe9s."}),"\n",(0,l.jsxs)(s.li,{children:["L'auteur conseille de ",(0,l.jsx)(s.strong,{children:"privil\xe9gier la s\xe9paration du processus de d\xe9cision plut\xf4t que l'injection des d\xe9pendances out-of-process"})," dans le domaine. On peut g\xe9rer la fuite de la logique vers le controller et la complexification du code du domaine avec certaines techniques."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Une de ces techniques est le pattern ",(0,l.jsx)(s.strong,{children:"CanExecute / Execute"}),"."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Imaginons qu'on veuille mettre \xe0 jour l'email du user seulement si son compte n'est pas encore confirm\xe9.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"1\xe8re possibilit\xe9 : on query les infos upfront, on donne tout \xe0 user, et le user d\xe9cide de changer ou non l'email. Mais on a peut \xeatre r\xe9cup\xe9r\xe9 les infos de la company pour rien, si le user \xe9tait d\xe9j\xe0 confirm\xe9 => probl\xe8me de performance."}),"\n",(0,l.jsx)(s.li,{children:"2\xe8me possibilit\xe9 : le controller v\xe9rifie lui-m\xeame si le compte du user est confirm\xe9 avant de faire \xe9ventuellement la query des infos de la company. Ici le controller a r\xe9cup\xe9r\xe9 une partie de la logique chez lui."}),"\n",(0,l.jsxs)(s.li,{children:["3\xe8me possibilit\xe9 (CanExecute / Execute) : le user expose une m\xe9thode ",(0,l.jsx)(s.code,{children:"canChangeEmail()"})," qui encapsule la logique de prise de d\xe9cision. Le controller n'a plus qu'\xe0 l'appeler pour d\xe9cider si on passe \xe0 l'\xe9tape suivante ou non. La d\xe9cision ne se fait plus vraiment au niveau du controller.","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// controller"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"canChangeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".canChangeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"!"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"canChangeEmail) {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" company);"})]})]})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Pour s'assurer que le controller n'a d'autre choix que d'appeler cette m\xe9thode avant d'aller plus loin (et donc lui retirer de la responsabilit\xe9), on va mettre une pr\xe9-condition dans la m\xe9thode ",(0,l.jsx)(s.code,{children:"user.changeEmail()"}),", o\xf9 on appelle explicitement ",(0,l.jsx)(s.code,{children:"canChangeEmail()"})," en v\xe9rifiant que la r\xe9ponse est oui. Et cette pr\xe9-condition m\xe9tier sera test\xe9e (contrairement \xe0 l'appel \xe0 ",(0,l.jsx)(s.code,{children:"canChangeEmail()"})," dans le controller).","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// user"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"canChangeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"() {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".isEmailConfirmed "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"?"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"false"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"true"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newEmail: Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" company: Company) {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"Precondition"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".requires"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".canChangeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"());"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Voici une autre de ces techniques concerne l'envoi de ",(0,l.jsx)(s.strong,{children:"domain events"})," :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On parle bien ici des domain events au sens DDD, ces events permettent d'informer les autres composants du syst\xe8me des \xe9tapes importantes qui ont lieu dans nos objets domaine."}),"\n",(0,l.jsxs)(s.li,{children:["Si on revient \xe0 notre exemple de CRM, au moment du changement d'email du user, le controller envoie un message dans un message bus. Mais cet envoi est fait dans tous les cas, m\xeame si le changement n'a pas eu lieu. On veut l'envoyer seulement si le changement est fait.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Pour enlever la d\xe9cision d'envoyer ou non l'event du controller, et la mettre dans le domaine, on va cr\xe9er une liste d‘events qu'on met \xe0 l'int\xe9rieur de la classe domaine."}),"\n",(0,l.jsxs)(s.li,{children:["On a un event :","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"EmailChanged"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Le User cr\xe9e l'event si l'envoi est confirm\xe9 :","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newEmail: Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" company: Company) {"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"emailChangedEvents"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".push"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"EmailChanged"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Et le Controller va it\xe9rer sur les domain events de User pour envoyer les bons messages dans le message bus :","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId: int"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail: Email) {"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" company);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"emailChangedEvents"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".forEach"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"((event) "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"messageBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".sendEmailChangedMessage"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"event"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"event"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".newEmail"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    );"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"On va donc pouvoir unit tester la cr\xe9ation de chaque domain event dans chaque cas dans le user, et on fera beaucoup moins d'integration tests pour v\xe9rifier que le controller lit bien les events du user et envoie ce qu'il faut."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Dans des projets plus gros, on pourrait vouloir fusionner les events avant de les dispatcher, cf. ",(0,l.jsx)(s.a,{href:"https://enterprisecraftsmanship.com/posts/merging-domain-events-dispatching/",children:"Merging domain events before dispatching"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Pour ce qui est de l'envoi de l'email, c'est un comportement observable de l'ext\xe9rieur donc il doit \xeatre fait que si l'email est chang\xe9. Par contre, l'\xe9criture en DB peut \xeatre faite inconditionnellement parce qu'elle est priv\xe9e et que le r\xe9sultat ne changera pas."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On a un petit souci de performance \xe0 \xe9crire en DB si l'email n'a pas chang\xe9, mais c'est un cas plut\xf4t rare."}),"\n",(0,l.jsx)(s.li,{children:"On peut aussi le mitiger par le fait que la plupart des ORM n'iront pas \xe9crire en DB si l'objet n'a pas chang\xe9. Donc on peut faire l'appel sans crainte."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Le conseil g\xe9n\xe9ral de Vladimir est de ne jamais introduire de d\xe9pendances out-of-process (m\xeame mock\xe9es dans les tests) dans le code du domaine. Il conseille plut\xf4t de fragmenter les appels au domaine, et au pire mettre ce code dans le controller et le tester par des tests d'int\xe9gration."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Les cas dans lesquels on va devoir mettre la logique dans le controller peuvent \xeatre par exemple :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"V\xe9rifier qu'un email est unique (il faut faire un appel out-of-process pour \xe7a)."}),"\n",(0,l.jsx)(s.li,{children:"G\xe9rer les cas d'erreur li\xe9s aux appels out-of-process."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"A propos de qui est le client de qui et de la notion de d\xe9tail d‘impl\xe9mentation :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Au niveau du controller, le client c'est l'utilisateur final, donc il faut tester ou mocker ce qui lui est visible ou sert directement son but. Les appels qui sont faits vers le domaine sont un d\xe9tail d'impl\xe9mentation."}),"\n",(0,l.jsx)(s.li,{children:"Au niveau du domaine, le client c'est le contr\xf4ler, donc il faut unit tester ce qui sert directement son but. Les appels \xe9ventuels vers d'autres classes du domaine sont des d\xe9tails d'impl\xe9mentation qu'on n'a pas \xe0 mocker."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"iii---integration-testing",children:"III - Integration testing"}),"\n",(0,l.jsx)(s.h3,{id:"8---why-integration-testing",children:"8 - Why integration testing?"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Pour rappel, un test d'int\xe9gration est un test qui ne r\xe9pond pas \xe0 au moins un des 3 crit\xe8res des tests unitaires : v\xe9rifier une unit\xe9 de comportement, le faire vite, le faire en isolation par rapport aux autres tests."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"En pratique les tests d'int\xe9gration vont \xeatre ceux qui g\xe8rent la relation avec les d\xe9pendances out-of-process."}),"\n",(0,l.jsx)(s.li,{children:"On est donc dans la partie “controllers” en termes de type de code."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Les r\xe8gles de la pyramide des tests sont de :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Couvrir le maximum de cas par des tests unitaires."}),"\n",(0,l.jsxs)(s.li,{children:["Tester ",(0,l.jsx)(s.strong,{children:"un happy path"}),", ainsi que ",(0,l.jsx)(s.strong,{children:"les edge cases qui ne peuvent pas \xeatre couverts par les tests unitaires"})," avec des tests d'int\xe9gration."]}),"\n",(0,l.jsx)(s.li,{children:"Quand la logique est simple, on a moins de tests unitaires, mais les tests d'int\xe9gration gardent leur valeur."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Quand un edge case am\xe8ne \xe0 un ",(0,l.jsx)(s.strong,{children:"crash imm\xe9diat"}),", il n'y a ",(0,l.jsx)(s.strong,{children:"pas besoin de le tester avec un test d'int\xe9gration"}),"."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Exemple du pattern CanExecute/Execute."}),"\n",(0,l.jsxs)(s.li,{children:["On appelle ce principe le ",(0,l.jsx)(s.strong,{children:"Fail Fast principle"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"On reste dans l'esprit co\xfbt/b\xe9n\xe9fice pour la maintenance d'un test, dans ce cas le b\xe9n\xe9fice n'est pas suffisant parce que ce genre de cas ne m\xe8ne pas \xe0 de la corruption de donn\xe9es, et est rapide \xe0 remarquer et \xe0 fixer."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Il y a 2 mani\xe8res de tester les ",(0,l.jsx)(s.strong,{children:"d\xe9pendances out-of-process"})," : les tester directement ou les remplacer par des mocks."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["On peut classer ces d\xe9pendances en deux cat\xe9gories :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Les ",(0,l.jsx)(s.strong,{children:"managed dependencies"})," sont celles que seuls nous utilisons, et que le monde externe ne conna\xeet pas. Exemple typique : la base de donn\xe9es.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Ces d\xe9pendances sont consid\xe9r\xe9es comme des d\xe9tails d'impl\xe9mentation."}),"\n",(0,l.jsxs)(s.li,{children:["On n'a donc pas \xe0 se pr\xe9occuper de nos interactions avec elles, ce qui compte c'est leur \xe9tat final, et l'impact que \xe7a aura sur le r\xe9sultat observable. Donc ",(0,l.jsx)(s.strong,{children:"pas besoin de mock"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Les ",(0,l.jsx)(s.strong,{children:"unmanaged dependencies"})," sont celles qui sont observables de l'ext\xe9rieur. Exemple typique : un serveur SMTP dont les mails seront visibles par les clients finaux, ou encore un message bus dont les messages vont affecter des composants externes \xe0 notre syst\xe8me.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Ces d\xe9pendances sont consid\xe9r\xe9es comme faisant partie du comportement observable."}),"\n",(0,l.jsxs)(s.li,{children:["Puisque les unmanaged dependencies sont observables, ils font partie de l'API publique, et donc il faut nous assurer que nos interactions avec elles restent les m\xeames : ",(0,l.jsx)(s.strong,{children:"les mocks sont parfaits pour \xe7a"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Il peut arriver qu'une d\xe9pendance soit \xe0 la fois managed et unmanaged : par exemple une base de donn\xe9es dont on choisit de partager certaines tables publiquement avec un composant externe.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Partager une DB est en g\xe9n\xe9ral une mauvaise id\xe9e parce que \xe7a va nous coupler fortement, il vaut mieux passer par une API synchrone ou un message bus."}),"\n",(0,l.jsx)(s.li,{children:"Ceci dit, si \xe7a arrive, il faudra diff\xe9rencier les tables partag\xe9es des tables priv\xe9es, et traiter chacune comme ce qu'elle est (managed/unmanaged) : des mocks pour assurer l'ensemble de nos interactions avec les tables partag\xe9es, et la v\xe9rification de l'\xe9tat final seulement pour les tables priv\xe9es."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Dans le cas o\xf9 on n'aurait pas la possibilit\xe9 de tester en int\xe9gration une DB priv\xe9e (base legacy trop grosse, trop co\xfbteuse, raisons de s\xe9curit\xe9 etc.), l'auteur conseille de ne pas \xe9crire de tests d'int\xe9gration du tout pour celles-ci, et de se concentrer sur les unit tests.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"La raison est que \xe7a compromet la r\xe9sistance aux refactorings en traitant une d\xe9pendance priv\xe9e comme publique, et \xe7a n'ajoute que tr\xe8s peu de protection contre des r\xe9gressions en plus des unit tests. Le rapport co\xfbt/b\xe9n\xe9fice n'est pas suffisant."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Si on reprend l'exemple du CRM, pour \xe9crire des tests d'int\xe9gration pour le ",(0,l.jsx)(s.code,{children:"UserController"})," :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["On va d'abord \xe9crire un test pour couvrir le ",(0,l.jsx)(s.strong,{children:"happy path le plus long"}),". Ici ce serait le cas o\xf9 on change l'email d'un user, qui passe de non corporate \xe0 corporate. On va mettre \xe0 jour en DB le user, les infos de company, et aussi envoyer le message dans le message bus pour l'email."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Il n'y a qu'un edge case non couvert par des unit tests : le cas o\xf9 l'email ne peut pas \xeatre chang\xe9. Mais dans ce cas on est sur du fail fast : une exception sera lanc\xe9e et le programme s'arr\xeatera. Donc pas besoin de test d'int\xe9gration pour \xe7a."}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["A propos des ",(0,l.jsx)(s.strong,{children:"tests end to end"}),", on peut en faire ",(0,l.jsx)(s.strong,{children:"quelques-uns pour notre projet"}),", et leur faire traverser les sc\xe9narios les plus longs pour s'assurer que tout est bien branch\xe9. On v\xe9rifiera le r\xe9sultat pour le client final au lieu de regarder dans la DB, et on v\xe9rifiera le message envoy\xe9 dans le message bus pour la d\xe9pendance externe \xe0 laquelle on n'a pas acc\xe8s. Ici pour cette feature on choisit de ne pas en faire."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Concernant notre test d'int\xe9gration de happy path donc, il faut d'abord d\xe9cider de la mani\xe8re dont on traite nos d\xe9pendances out-of-process : la DB est managed donc doit \xeatre test\xe9e au niveau de son \xe9tat pour le ",(0,l.jsx)(s.code,{children:"user"})," et la ",(0,l.jsx)(s.code,{children:"company"}),", alors que le message bus est unmanaged donc doit \xeatre mock\xe9 pour tester les interactions avec lui."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Notre test va contenir ",(0,l.jsx)(s.strong,{children:"3 sections"})," :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"D'abord mettre le user et la company en DB et initialiser le mock pour le message bus. (Arrange)"}),"\n",(0,l.jsx)(s.li,{children:"Ensuite appeler la m\xe9thode de notre controller. (Act)"}),"\n",(0,l.jsx)(s.li,{children:"Et enfin tester le r\xe9sultat en DB et l'interaction avec notre mock (Assert)."}),"\n"]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"it"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"changes email from non corporate to corporate"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" () "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Arrange"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"db"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".createCompany"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"mycorp.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"db"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".createUser"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"user@gmail.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"customer"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"busMock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" { send"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"jest"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".fn"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"() };"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserController"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"MessageBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(busMock));"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Act"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"user@mycorp.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Assert"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"db"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".getUserById"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".email)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"user@mycorp.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".type)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"employee"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"db"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".getCompany"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"company"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".numberOfEmployees)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"busMock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".send)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toHaveBeenCalledTimes"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"busMock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".send)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toHaveBeenCalledWith"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toInclude"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"1"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"));"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"busMock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".send)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toHaveBeenCalledWith"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toInclude"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"user@mycorp.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  );"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"});"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.strong,{children:"Il ne faut pas utiliser les m\xeames objets entre les sections"}),", de mani\xe8re \xe0 \xeatre s\xfbr \xe0 chaque fois de lire et \xe9crire depuis la DB."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.strong,{children:"L'introduction d'interfaces pr\xe9matur\xe9es est une mauvaise id\xe9e"}),". Il faut en introduire une quand elle existe d\xe9j\xe0 mais est implicite, c'est-\xe0-dire quand il y a ",(0,l.jsx)(s.strong,{children:"au moins deux impl\xe9mentations"})," de celle-ci."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le principe fondamental ici c'est YAGNI (you ain't gonna need it) qui dit que le code suppos\xe9ment utile pour plus tard ne le sera sans doute pas, ou pas sous cette forme."}),"\n",(0,l.jsxs)(s.li,{children:["Pour plus d'info sur le trade off YAGNI vs OCP, l'auteur a fait ",(0,l.jsx)(s.a,{href:"https://enterprisecraftsmanship.com/posts/ocp-vs-yagni/",children:"un article"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["Par cons\xe9quent, \xe9tant donn\xe9 qu'un mock est une impl\xe9mentation de plus, il nous faudra la plupart du temps ",(0,l.jsx)(s.strong,{children:"faire une interface seulement pour les unmanaged dependencies"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Quelques bonnes pratiques pour les tests d'int\xe9gration :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Cr\xe9er une s\xe9paration explicite entre domain model et controllers"})," permet de savoir quoi tester unitairement, et quoi tester en int\xe9gration."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Limiter le nombre de couches \xe0 seulement 3"})," : infrastructure layer, domain layer et application service layer.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"David J. Wheeler a dit \xe0 ce propos : “All problems in computer science can be solved by another layer of abstraction, except for the problem of too many layers of abstraction.”"}),"\n",(0,l.jsx)(s.li,{children:"On se retrouve souvent avec 4, 5, 6 layers, ce qui rend l'ajout d'une feature, et m\xeame la compr\xe9hension d'une feature complexe parce qu'on doit toucher \xe0 de nombreux fichiers."}),"\n",(0,l.jsx)(s.li,{children:"On a souvent tendance \xe0 tester le layer du dessous depuis le layer du dessus. Et avec de nombreux layers on aboutit \xe0 de nombreux tests avec mocks qui apportent chacun peu de valeur."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"\xc9liminer les d\xe9pendances circulaires"})," : quand deux classes d\xe9pendent l'une de l'autre pour fonctionner.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Les d\xe9pendances circulaires cr\xe9ent aussi une difficult\xe9 \xe0 appr\xe9hender le code parce qu'on ne sait pas par o\xf9 commencer."}),"\n",(0,l.jsx)(s.li,{children:"Par exemple, quand une classe en instancie une autre et lui passe une instance d'elle-m\xeame. On se retrouve \xe0 introduire des interfaces et utiliser des mocks pour les tests."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Ne pas mettre plusieurs Act dans le m\xeame test"})," : parfois on est tent\xe9 de mettre en place plusieurs Arrange/Act/Assert \xe0 la suite dans le m\xeame test. C'est une mauvaise id\xe9e parce que le test devient difficile \xe0 lire et \xe0 modifier, et a tendance \xe0 grossir encore."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["A propos de la question des ",(0,l.jsx)(s.strong,{children:"logs"})," :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Selon l'auteur, ",(0,l.jsx)(s.strong,{children:"les logs doivent \xeatre test\xe9"})," uniquement s'ils sont destin\xe9s \xe0 \xeatre ",(0,l.jsx)(s.strong,{children:"observ\xe9s par des personnes autres que les d\xe9veloppeurs"})," eux-m\xeames."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Par exemple des personnes du business qui en ont besoin pour des insights."}),"\n",(0,l.jsxs)(s.li,{children:["Steve Freeman et Nat Pryce distinguent deux types de logs dans ",(0,l.jsx)(o.f,{children:"Growing Object-Oriented Software, Guided by Tests"})," : le ",(0,l.jsx)(s.strong,{children:"support logging"})," qui est destin\xe9 au personnel de support et sysadmins, et le ",(0,l.jsx)(s.strong,{children:"diagnostic logging"})," qui est destin\xe9 aux d\xe9veloppeurs eux-m\xeames pour du d\xe9bug."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Il faut bien distinguer le diagnostic logging et le support logging, en n'y appliquant pas la m\xeame technique de code."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Le support logging \xe9tant plus important, on pourra utiliser une classe \xe0 part inspir\xe9e du ",(0,l.jsx)(s.strong,{children:"structured logging"})," : une mani\xe8re de logger qui s\xe9pare les param\xe8tres et le texte principal, de mani\xe8re \xe0 pouvoir reformater ces logs comme on veut."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Exemple de code :"}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"domainLogger"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".userTypeHasChanged"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"45"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"customer"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"corporate"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"DomainLogger"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"userTypeHasChanged"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    oldType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    newType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserType"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  ) {"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"logger"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".info"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`User "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" changed type ``from "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"oldType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" to "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"newType"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    );"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Pour le tester il va falloir le traiter comme une ",(0,l.jsx)(s.strong,{children:"d\xe9pendance out-of-process unmanaged"})," (puisqu'elle ne nous est pas priv\xe9e). Et donc on peut faire comme avec le message envoy\xe9 dans le message bus :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Si c'est le controller qui doit faire le log, il peut le faire directement et ce sera test\xe9 dans un test d'int\xe9gration sous forme de mock."}),"\n",(0,l.jsx)(s.li,{children:"Si c'est le code de domaine qui le fait, il faut s\xe9parer la logique d'envoi du log de l'envoi du log lui-m\xeame : cr\xe9er un domain event pour l'envoi de ce log dans le domaine, et it\xe9rer sur les events de log dans le controller pour logger les logs dans la d\xe9pendance out-of-process. Le test pourra \xeatre fait sous forme unitaire pour v\xe9rifier la cr\xe9ation du domain event."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Concernant la ",(0,l.jsx)(s.strong,{children:"quantit\xe9 de logs"})," :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Pour le support logging la question ne se pose pas : il en faut autant qu'il y a de requirement business."}),"\n",(0,l.jsxs)(s.li,{children:["Pour le diagnostic logging il faut faire ",(0,l.jsx)(s.strong,{children:"attention \xe0 ne pas en abuser"})," :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Trop de logs noient l'information importante."}),"\n",(0,l.jsx)(s.li,{children:"M\xeame si on log avec des niveaux diff\xe9rents, on pollue quand m\xeame le code avec des lignes de log un peu partout, ce qui rend plus difficile la lecture."}),"\n",(0,l.jsx)(s.li,{children:"L'auteur conseille de ne pas utiliser de logs dans le domaine, et dans ne le controller les utiliser que temporairement pour trouver un bug, puis les enlever."}),"\n",(0,l.jsx)(s.li,{children:"Id\xe9alement il faudrait que les logs ne servent que pour les exceptions non g\xe9r\xe9es."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Concernant la mani\xe8re de passer le logger \xe0 nos objets, l'auteur conseille de le passer explicitement dans le constructeur ou dans l'appel \xe0 une m\xe9thode."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"9---mocking-best-practices",children:"9 - Mocking best practices"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Il faut mocker les unmanaged dependencies ",(0,l.jsx)(s.strong,{children:"\xe0 l'edge (au bord) de notre syst\xe8me"}),"."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["La raison est d'augmenter la protection contre les r\xe9gressions en mettant en jeu le plus possible de code. On va donc ",(0,l.jsx)(s.strong,{children:"mocker au plus pr\xe8s de l'appel \xe0 la d\xe9pendance externe"}),".","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"On am\xe9liore aussi la r\xe9sistance aux refactorings parce que ce qui est mock\xe9 est une API publique, et donc peu susceptible de changer contrairement \xe0 notre code interne."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Exemple : Si on a une classe ",(0,l.jsx)(s.code,{children:"MessageBus"})," qui encapsule et ajoute des fonctionnalit\xe9s \xe0 une classe ",(0,l.jsx)(s.code,{children:"Bus"})," qui elle-m\xeame est un simple wrapper autour de la d\xe9pendance externe, il faut mocker ",(0,l.jsx)(s.code,{children:"Bus"})," et non pas ",(0,l.jsx)(s.code,{children:"MessageBus"}),".","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"MessageBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" _bus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Bus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Dans les tests on va peut \xeatre instancier un peu plus de choses pour que le mock soit en bout de cha\xeene, mais c'est pas grave :","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Arrange"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"busMock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" Mock"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"&"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"lt;IBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"messageBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"MessageBus"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(busMock);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sut"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserController"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(messageBus)"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Assert"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(busMock)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toHaveBeenCalledWith"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"/* ... */"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pour le mock de notre ",(0,l.jsx)(s.code,{children:"DomainLogger"}),", on n'est pas oblig\xe9s d'aller jusqu'\xe0 l'edge parce que contrairement \xe0 ",(0,l.jsx)(s.code,{children:"MessageBus"})," o\xf9 la structure exacte des message est cruciale pour maintenir la compatibilit\xe9 avec la lib, ",(0,l.jsx)(s.strong,{children:"la structure exacte des messages de log nous importe peu"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Quand on veut mocker du code r\xe9utilis\xe9 dans de nombreux endroits (ce qui est en g\xe9n\xe9ral le cas du code qui est \xe0 l'edge du syst\xe8me), il peut \xeatre plus lisible d'",(0,l.jsx)(s.strong,{children:"impl\xe9menter son propre objet de mock"}),", qui est par d\xe9finition un spy."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Exemple de spy :"}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"busSpy"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"send"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(message"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"string"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sentMessages"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".push"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(message);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"shouldSendNumberOfMessages"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(num"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"sentMessages"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"length"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBe"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(num);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"withEmailChangedMessage"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"number"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"message"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`Type: user email changed id: "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"``email: "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"newEMail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".sentMessages)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toContain"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(message);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Utilisation dans le code :"}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"busSpy"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".shouldSendNumberOfMessages"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".withEmailChangedMessage"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"new@gmail.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]})]})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Bonnes pratiques pour les mocks :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Vu que les mocks doivent \xeatres r\xe9serv\xe9s aux d\xe9pendances out-of-process unmanaged, ils doivent \xeatre ",(0,l.jsx)(s.strong,{children:"seulement dans les tests d'int\xe9gration"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"On peut utiliser autant de mocks que n\xe9cessaire pour g\xe9rer toutes les d\xe9pendances out-of-process unmanaged qui sont utilis\xe9es dans notre controller."}),"\n",(0,l.jsxs)(s.li,{children:["Pour bien s'assurer de la stabilit\xe9 de l'utilisation de l'API publique constitu\xe9e par notre d\xe9pendance unmanaged, il faut ",(0,l.jsx)(s.strong,{children:"aussi v\xe9rifier le nombre d'appels"})," vers la d\xe9pendance."]}),"\n",(0,l.jsxs)(s.li,{children:["Il ne faut ",(0,l.jsx)(s.strong,{children:"mocker que les classes qu'on poss\xe8de"}),". Ca veut dire qu'il faut wrapper toute d\xe9pendance unmanaged out-of-process par un adapter qui repr\xe9sente notre utilisation de cette d\xe9pendance. C'est ce wrapper qu'on va mocker.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Un des avantages c'est que si la d\xe9pendance change de mani\xe8re importante dans son interface, elle ne pourra pas impacter le reste de notre code sans qu'on change notre wrapper. Il s‘agit d'une protection."}),"\n",(0,l.jsxs)(s.li,{children:["A l'inverse, selon l'auteur, ",(0,l.jsx)(s.strong,{children:"cr\xe9er des wrappers autour de d\xe9pendances qui ne sont pas unmanaged ne vaut pas le coup"})," en terme de maintenance. Un exemple en est l'ORM."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"10---testing-the-database",children:"10 - Testing the database"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Il est pr\xe9f\xe9rable d'avoir tout ce qui concerne la ",(0,l.jsx)(s.strong,{children:"structure de la base de donn\xe9es dans l'outil de versionning"}),", tout comme le code."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["En plus de la structure, certaines donn\xe9es sont en fait des ",(0,l.jsx)(s.strong,{children:"reference data"}),", et doivent \xeatre aussi versionn\xe9es avec le code."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Il s'agit de donn\xe9es qu'il faut g\xe9n\xe9rer pour que l'application puisse fonctionner."}),"\n",(0,l.jsx)(s.li,{children:"On peut diff\xe9rencier les reference data du reste en se demandant si l'application peut modifier ces donn\xe9es : si non alors ce sont des reference data."}),"\n",(0,l.jsxs)(s.li,{children:["Exemple : imaginons qu'on reprenne notre exemple CRM, et qu'on veuille mettre le type d'utilisateur en base. Si on veut garantir par la DB elle-m\xeame que le type ne sera pas autre chose que les types autoris\xe9s, on peut cr\xe9er une table ",(0,l.jsx)(s.code,{children:"UserTypes"}),", y mettre les types autoris\xe9s, et faire une foreign key depuis la table ",(0,l.jsx)(s.code,{children:"User"})," vers cette table.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Les donn\xe9es dans cette table sont l\xe0 juste pour des raisons techniques, pour faire ce qui est fait ou pourrait l'\xeatre dans le code mais avec plus de s\xe9curit\xe9. Elles ne sont pas accessibles aux utilisateurs de l'application. Ce sont des reference data."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Il est pr\xe9f\xe9rable de permettre \xe0 tous les d\xe9veloppeurs d'avoir leur base de donn\xe9es (id\xe9alement sur leur machine locale)."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Une DB partag\xe9e peut devenir inutilisable, au moins momentan\xe9ment, et ne permet pas de garantir l'ex\xe9cution des tests vu que des modifications peuvent \xeatre faites par les autres d\xe9veloppeurs."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Il y a deux types d'approche pour le d\xe9veloppement vis-\xe0-vis de la base de donn\xe9es : la delivery state-based et migration-based."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["La ",(0,l.jsx)(s.strong,{children:"state-based"})," consiste \xe0 avoir l'\xe9tat actuel de la structure de la DB versionn\xe9e. On va alors cr\xe9er une DB mod\xe8le \xe0 partir de cette structure, puis utiliser un outil de comparaison qui va la comparer avec la DB de production, pour ensuite appliquer les modifications sur la production."]}),"\n",(0,l.jsxs)(s.li,{children:["La ",(0,l.jsx)(s.strong,{children:"migration-based"})," consiste \xe0 \xe9crire des scripts de migration qui vont \xeatre versionn\xe9es. On ne conna\xeet pas l'\xe9tat actuel de la DB depuis ces scripts, mais les jouer tous dans l'ordre permet d'en obtenir un exemplaire.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"L'outil de comparaison de DB ne sera pas utilis\xe9 ici, sauf pour \xe9ventuellement permettre de d\xe9tecter des anomalies dans la DB de prod."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["La state-based est plus utile pour g\xe9rer les conflits de merge en ayant l'\xe9tat explicite, alors que la migration-based est plus utile pour g\xe9rer la ",(0,l.jsx)(s.em,{children:"data motion"})," (le fait de changer la structure de la DB avec des donn\xe9es dedans).","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"La raison est que g\xe9rer la transformation de donn\xe9es existantes est difficile \xe0 faire automatiquement, il faut y appliquer des r\xe8gles m\xe9tier."}),"\n",(0,l.jsxs)(s.li,{children:["Dans la plupart des cas, g\xe9rer la data motion est plus important que la gestion de conflits de merge. Donc il vaut mieux ",(0,l.jsx)(s.strong,{children:"pr\xe9f\xe9rer l'approche migration-based"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Il ne faut jamais faire de changements directement dans la DB sans passer par l'app, autrement que par des scripts de migration versionn\xe9s."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Si une migration est incorrecte, il vaut mieux faire une migration pour la corriger (sauf si elle n'a pas encore \xe9t\xe9 jou\xe9e et que la jouer am\xe8nera \xe0 de la perte de donn\xe9es)."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["A propos de la gestion des ",(0,l.jsx)(s.strong,{children:"transactions"})," dans nos DB :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Les transactions sont importantes \xe0 la fois dans le code pour garantir la consistance des donn\xe9es, et aussi dans les tests pour s'assurer qu'ils sont fiables."}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Dans le code, on a deux notions li\xe9es \xe0 la DB :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Les ",(0,l.jsx)(s.strong,{children:"transactions"})," qui d\xe9cident si les modifications faites doivent \xeatre gard\xe9es ou non. Elles durent le temps de l'op\xe9ration enti\xe8re."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Les ",(0,l.jsx)(s.strong,{children:"repositories"})," qui prennent une transaction, et agissent sur les donn\xe9es (en lecture ou \xe9criture) dans le cadre de cette transaction."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Exemple dans notre controller du CRM :"}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public UserController {"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"public "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserController"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    private transaction: Transaction"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".userRepository "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserRepository"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(transaction);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"userRepository"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".getById"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId);"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"userRepository"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".save"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(user);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"transaction"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".commit"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// [...]"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Il existe aussi un pattern appel\xe9 ",(0,l.jsx)(s.strong,{children:"unit of work"}),", qui consiste \xe0 retenir les modifications sur les objets qui doivent avoir lieu au cours d'une transaction, et \xe0 les soumettre en une seule fois \xe0 la DB au moment o\xf9 la transaction est valid\xe9e."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Ca permet notamment d'\xe9conomiser le nombre de connexions \xe0 la DB. La plupart des ORM l'impl\xe9mentent."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Dans le cas o\xf9 on travaille avec les document databases comme MongoDB, les transactions sont souvent garanties au sein d'un m\xeame document seulement."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Dans ce cas, il faut se d\xe9brouiller pour que nos op\xe9rations n'affectent qu'un document. Si on utilise le domain model pattern du DDD, on pourra affecter un aggregate par document et suivre la guideline de ne mettre \xe0 jour qu'un document \xe0 la fois."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Concernant les tests d'int\xe9gration, ",(0,l.jsx)(s.strong,{children:"il faut que chacun des 3 blocs (Arrange, Act, Assert) ait sa transaction \xe0 lui."})]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"La raison est de chercher \xe0 reproduire au mieux l'environnement de production. Dans le cas contraire on peut par exemple se retrouver \xe0 avoir certaines de nos libs (ORM notamment) qui vont mettre en cache certaines donn\xe9es au lieu d'aller lire/\xe9crire en DB explicitement."}),"\n",(0,l.jsx)(s.li,{children:"\xc7a compromet donc l'id\xe9e de wrapper chaque test dans une transaction qu'on annule \xe0 la fin du test (l'id\xe9e est \xe9voqu\xe9e et balay\xe9e pour cette raison)."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Selon l'auteur, la ",(0,l.jsx)(s.strong,{children:"parall\xe9lisation des tests d'int\xe9gration n'en vaut pas le coup"}),", parce que \xe7a n\xe9cessite trop d'efforts. Il vaut mieux les jouer s\xe9quentiellement, et cleaner les donn\xe9es entre les tests."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Il sugg\xe8re de ",(0,l.jsx)(s.strong,{children:"cleaner au d\xe9but de chaque test"}),". Le faire \xe0 la fin peut poser probl\xe8me \xe0 cause de potentiel crash avant la fin."]}),"\n",(0,l.jsxs)(s.li,{children:["Concernant la mani\xe8re d'effacer les donn\xe9es, il sugg\xe8re une simple commande SQL de type ",(0,l.jsx)(s.code,{children:"DELETE FROM dbo.User;"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Il vaut mieux ",(0,l.jsx)(s.strong,{children:"\xe9viter d'utiliser une DB “in memory”"})," \xe0 la place de la vraie DB dans les tests d'int\xe9gration. \xc7a permet de transformer les tests d'int\xe9gration en unit tests, mais \xe7a leur enl\xe8ve aussi de la fiabilit\xe9 vis-\xe0-vis de l'int\xe9gration \xe0 cause des diff\xe9rences entre les deux bases de donn\xe9es."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Selon l'auteur on va finir de toute fa\xe7on par faire des tests d'int\xe9gration \xe0 la main si on va sur une BD diff\xe9rente."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["On peut utiliser certaines ",(0,l.jsx)(s.strong,{children:"techniques de refactoring"})," pour rendre le code des tests d'int\xe9gration plus lisible :"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Pour la section Arrange : on peut par exemple utiliser des m\xe9thodes de type factory pour que la cr\xe9ation des objets en base avec transaction prenne moins de place."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Le pattern ",(0,l.jsx)(s.strong,{children:"Object mother"})," consiste \xe0 avoir une m\xe9thode qui cr\xe9e l'objet, et le renvoie."]}),"\n",(0,l.jsx)(s.li,{children:"Il conseille de commencer par mettre ces m\xe9thodes dans la classe de test, et de ne les d\xe9placer que si besoin de r\xe9utilisation."}),"\n",(0,l.jsx)(s.li,{children:"On peut mettre des valeurs par d\xe9faut aux arguments, pour n'avoir \xe0 sp\xe9cifier que ceux qui sont n\xe9cessaires."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Pour la section Act : on peut aussi utiliser une fonction helper pour r\xe9duire \xe7a \xe0 un appel qui cr\xe9era la transaction et la passera \xe0 la m\xe9thode test\xe9e, comme en production."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Ex :","\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsx)(s.code,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"result"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"execute"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(() "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".changeEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(userId"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"new@gmail.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"));"})]})})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Pour la section Assert : l\xe0 aussi on peut utiliser des fonctions helper :"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"On peut mettre des fonctions qui abstraient le fait d'aller chercher des donn\xe9es en base."}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsx)(s.code,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"queryUser"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".id);"})]})})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["On peut cr\xe9er une classe exposant une ",(0,l.jsx)(s.strong,{children:"fluent interface"})," par dessus des instructions assert."]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"UserExtensions"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"shouldExist"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(user)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toBeTruthy"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" user;"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"withEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"User"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Email"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"expect"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(email)"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toEqual"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".email);"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" user;"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// In test"})}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"user"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".shouldExist"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"()"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".withEmail"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"new@gmail.com"'}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"TODO : ce code ne fonctionne pas en l'\xe9tat, il faudrait trouver le moyen de faire de l'extension de m\xe9thode en Typescript."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Avec les helpers qui cr\xe9ent des objets dans la section Arrange, ou qui lisent des objets dans la section Assert, on cr\xe9e plus que 3 transactions en tout. Pour autant, \xe7a reste un bon trade off selon l'auteur : on sacrifie un peu de performance du test, contre une am\xe9lioration substantielle de maintenabilit\xe9 du test."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Faut-il ",(0,l.jsx)(s.strong,{children:"tester les op\xe9rations de lecture"})," ? (comme renvoyer une information au client)"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Le plus important est de tester les op\xe9rations d'\xe9criture qui peuvent corrompre les donn\xe9es. Pour celles de lecture il n'y a pas ce genre d'enjeu, donc la barre pour ajouter des tests est plus haute : il ne faut tester que les op\xe9rations les plus complexes."}),"\n",(0,l.jsxs)(s.li,{children:["En fait, l'int\xe9r\xeat principal du domain model c'est de prot\xe9ger la consistance des donn\xe9es \xe0 travers l'encapsulation. Dans les op\xe9rations de lecture il n'y en a pas besoin.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"L'auteur conseille donc de ne tester les op\xe9rations qu'avec des tests d'int\xe9gration, et seulement pour celles qu'on veut tester."}),"\n",(0,l.jsx)(s.li,{children:"Il conseille aussi d'\xe9crire les requ\xeates pour la lecture directement en SQL, l'ORM n'\xe9tant pas utile dans ce cas, et ajoutant des couches d'abstractions inutiles et peu performantes."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Faut-il ",(0,l.jsx)(s.strong,{children:"tester les repositories"})," ?"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Non"}),". Malgr\xe9 l'int\xe9r\xeat apparent, le rapport b\xe9n\xe9fice/co\xfbt est d\xe9favorable :","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"D'un c\xf4t\xe9 les repositories manipulent la DB qui est une d\xe9pendance out-of-process, donc si on les testait, ce serait avec des tests d'int\xe9gration (et ceux-ci co\xfbtent cher)."}),"\n",(0,l.jsx)(s.li,{children:"De l'autre, ils ne fournissent pas tant de protection contre les r\xe9gressions que \xe7a, et surtout ils sont pour l'essentiel d\xe9j\xe0 test\xe9s par les tests d'int\xe9gration des controllers."}),"\n",(0,l.jsx)(s.li,{children:"Si on arrive \xe0 isoler les factories \xe0 part, \xe7a pourrait valoir le coup de les tester \xe0 part unitairement, mais quand on utilise un ORM, on ne peut en g\xe9n\xe9ral pas tester le mapping \xe0 part de la DB."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Il en est de m\xeame pour les event dispatchers par exemple, dont le rapport b\xe9n\xe9fice/co\xfbt des tests sera d\xe9favorable."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"iv---unit-testing-anti-patterns",children:"IV - Unit testing anti-patterns"}),"\n",(0,l.jsx)(s.h3,{id:"11---unit-testing-anti-patterns",children:"11 - Unit testing anti-patterns"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.strong,{children:"Il ne faut pas rendre publique une m\xe9thode priv\xe9e"}),", juste pour la tester."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"La 1\xe8re r\xe8gle est de tester la fonctionnalit\xe9 priv\xe9e par l'effet qu'elle a sur l'API publique."}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Si la fonctionnalit\xe9 priv\xe9e est trop compliqu\xe9e pour \xeatre test\xe9e \xe0 travers ce qui est public, c'est le signe d'une ",(0,l.jsx)(s.strong,{children:"abstraction manquante"}),". Il faut alors la mat\xe9rialiser."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Exemple de code dont on a envie de tester la m\xe9thode priv\xe9e ",(0,l.jsx)(s.code,{children:"getPrice()"})," sans passer par la m\xe9thode publique :"]}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Order"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"generateDescription"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"() {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`Name: "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".name"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:", ``total price: "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".getPrice"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"()"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"private"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"getPrice"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"() {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// de la logique compliqu\xe9e ici"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"On mat\xe9rialise l'abstraction manquante et on la teste avec de l'output-based testing :"}),"\n",(0,l.jsx)(s.pre,{"data-language":"typescript","data-theme":"default",children:(0,l.jsxs)(s.code,{"data-language":"typescript","data-theme":"default",children:[(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Order"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"generateDescription"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"() {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"calculator"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"PriceCalculator"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`Name: "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".name"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:", ``total price: ``"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"calculator"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".calculate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"      "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"this"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:".products"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    )"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:" "}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"class"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"PriceCalculator"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"public"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"calculate"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(products"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"Products"}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[]) {"})]}),"\n",(0,l.jsxs)(s.span,{className:"line",children:[(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,l.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// de la logique compliqu\xe9e ici"})]}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  }"})}),"\n",(0,l.jsx)(s.span,{className:"line",children:(0,l.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Il en est de m\xeame avec un attribut priv\xe9 : le rendre public juste pour le tester est un antipattern."}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.strong,{children:"Il ne faut pas faire fuiter du domain knowledge du code vers les tests"})," : r\xe9utiliser le m\xeame algorithme dans le test ne permettra pas de remarquer qu'on s'est tromp\xe9.\n_ Un exemple simple peut \xeatre un code qui fait une addition :\n",(0,l.jsx)(s.code,{children:"return a + b"}),", et un test qui teste avec l'addition aussi : ",(0,l.jsx)(s.code,{children:"expect(result).toBe(3 + 2);"}),"\n",(0,l.jsx)(s.strong,{children:"Il vaut mieux v\xe9rifier des valeurs pr\xe9-calcul\xe9es"})," sans r\xe9impl\xe9menter l'algo : ",(0,l.jsx)(s.code,{children:"expect(result).toBe(5);"}),"\n_ Si on copie l'algo dans le test, alors on aura tendance \xe0 mettre \xe0 jour en m\xeame temps le code et le test en cas de changement, sans pouvoir se rendre compte que l'algo est faux. * Id\xe9alement il faut pr\xe9-calculer le r\xe9sultat \xe0 expect dans le test avec l'aide d'un expert m\xe9tier (quand on n'est pas expert nous-m\xeames comme pour l'addition), et en tout cas il ne faut pas obtenir le calcul \xe0 partir du code qui est cens\xe9 \xeatre test\xe9."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["La ",(0,l.jsx)(s.strong,{children:"code pollution"})," consiste \xe0 introduire des choses dans le code, qui ne sont utiles que pour le test. C'est un antipattern."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Par exemple avoir un ",(0,l.jsx)(s.code,{children:"if(testEnvironment) ... else ..."})," introduit de la pollution qui posera des probl\xe8mes de maintenance plus tard."]}),"\n",(0,l.jsxs)(s.li,{children:["On peut en g\xe9n\xe9ral r\xe9gler le probl\xe8me avec des interfaces : par exemple s'il s'agit d'\xe9viter certaines op\xe9rations de log dans les tests en ne loggant pas si on est en env de test, on peut injecter le logger dans le code avec une interface. Dans le test on donnera une version fake du logger qui ne log pas.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["L'interface est une petite pollution aussi, mais elle cr\xe9e beaucoup moins de danger que des bouts de code dans des ",(0,l.jsx)(s.code,{children:"if"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["On est parfois tent\xe9 de vouloir ",(0,l.jsx)(s.strong,{children:"stubber/mocker une seule m\xe9thode d'une classe"})," qui fait quelque chose de complexe, pour tester ce qui est complexe et \xe9viter qu'elle ne communique avec une d\xe9pendance out-of-process. Ceci est un antipattern."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"La bonne fa\xe7on de faire est de s\xe9parer la logique complexe de la partie qui communique la chose \xe0 la d\xe9pendance out-of-process (typiquement avec un humble object pattern qui fait le lien entre les deux), et unit tester la logique."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Concernant la ",(0,l.jsx)(s.strong,{children:"notion de temps"})," utilis\xe9e dans le code (",(0,l.jsx)(s.code,{children:"new Date()"}),"), l'introduire en tant qu'\xe9l\xe9ment statique est, comme dans le cas du logger, un antipattern qui introduit une d\xe9pendance partag\xe9e dans les tests, et pollue le code."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["La bonne mani\xe8re est d'",(0,l.jsx)(s.strong,{children:"introduire la d\xe9pendance temporelle explicitement"})," dans le constructeur ou la m\xe9thode appel\xe9e."]}),"\n",(0,l.jsx)(s.li,{children:"On peut le faire soit sous forme de service appelable pour obtenir la date, soit en passant la valeur pr\xe9-g\xe9n\xe9r\xe9e. Passer la valeur directement est ce qui pr\xe9sente le moins d'inconv\xe9nients, \xe0 la fois pour la clart\xe9 du code, et pour la testabilit\xe9."}),"\n"]}),"\n"]}),"\n"]})]})}s.default=(0,r.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,i.a)(),e.components);return s?(0,l.jsx)(s,{...e,children:(0,l.jsx)(a,{...e})}):a(e)},pageOpts:{filePath:"pages/books/unit-testing.mdx",route:"/books/unit-testing",title:"Unit Testing: Principles, Practices, and Patterns",headings:t},pageNextRoute:"/books/unit-testing"})},7854:function(e,s,n){"use strict";n.d(s,{f:function(){return r}});var l=n(5893);function r(e){let{children:s}=e;return(0,l.jsx)("em",{style:{color:"#a64d79",fontWeight:"bold",fontStyle:"italic"},children:s})}}},function(e){e.O(0,[673,888,774,179],function(){return e(e.s=5032)}),_N_E=e.O()}]);